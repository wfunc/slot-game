# 老虎机游戏 Protocol Buffers WebSocket 测试指南

## 概述
本文档介绍如何测试基于 Protocol Buffers v2 的老虎机游戏 WebSocket 实现。

## 实现功能

### 1. 消息格式
所有消息使用二进制格式传输：
```
[4字节长度][2字节消息ID][protobuf数据]
```

### 2. 支持的消息类型

| 消息ID | 方向 | 名称 | 说明 |
|--------|------|------|------|
| 1901 | C->S | m_1901_tos | 进入房间请求 |
| 1901 | S->C | m_1901_toc | 进入房间响应 |
| 1902 | C->S | m_1902_tos | 开始游戏请求 |
| 1902 | S->C | m_1902_toc | 游戏结果响应 |
| 1903 | S->C | p_1903_toc | 数据推送（余额、JP等）|

## 测试步骤

### 1. 启动服务器
```bash
make run
```
服务器将在 `http://localhost:8080` 启动

### 2. 打开测试页面
使用浏览器访问：
```
http://localhost:8080/static/websocket-test.html
```

### 3. 连接WebSocket
1. URL 默认设置为 `ws://localhost:8080/ws/slot`
2. 消息格式选择 "Protobuf (二进制)"
3. 点击"连接"按钮

### 4. 测试游戏流程

#### a. 进入房间
点击"进入房间 (1901)"按钮，将发送进入房间请求：
- 请求：type = 1 (麻将类型)
- 响应：返回下注档位和赔率信息

#### b. 开始游戏
点击以下任一按钮开始游戏：
- "开始游戏 (1902) - 100币"
- "开始游戏 (1902) - 200币"
- "开始游戏 (1902) - 500币"

游戏响应包含：
- 下注金额
- 赢取金额
- 游戏结果（5x4 网格）
- 奖励信息

#### c. 数据推送
每次游戏后会自动推送 1903 消息，包含：
- 当前金币余额
- 累计赢取
- JP奖池信息

## 游戏特性

### 金色Wild系统
- 12%概率出现金色符号
- 金色符号消除后变成Wild
- Wild可替代任何符号
- Wild只在参与消除时消失

### 连锁系统
- 最少3连即可消除
- 最多10连锁
- 连锁倍数递增：1x, 1.5x, 2x, 3x, 5x, 8x, 12x, 18x, 25x, 40x

### 符号类型
- 发财、红中、白板、八万（高价值）
- 六筒、六条、三筒、二条（低价值）
- Wild符号（-1）

## 调试信息

### 服务端日志
服务器会输出详细日志：
```
[SlotHandler] 新玩家连接: xxx
[SlotHandler] 玩家 xxx 进入房间，类型: 1
[SlotHandler] 玩家 xxx 开始游戏，下注: 100
[SlotHandler] 发送消息 ID=1902, 长度=xxx字节
```

### 客户端显示
测试页面会显示：
- 发送的消息（包括消息ID和内容）
- 接收的消息（解码后的内容）
- 连接状态和统计信息

## 注意事项

1. **初始余额**：每个玩家连接时获得10000金币初始余额
2. **余额检查**：下注金额不能超过当前余额
3. **连接管理**：断开连接时会清理会话数据
4. **并发支持**：支持多个玩家同时连接和游戏

## 故障排除

### 连接失败
- 检查服务器是否正在运行
- 确认WebSocket URL正确（ws://localhost:8080/ws/slot）
- 检查浏览器控制台是否有错误信息

### 消息发送失败
- 确认已成功连接WebSocket
- 检查消息格式选择是否为"Protobuf (二进制)"

### 游戏无响应
- 必须先发送进入房间请求（1901）
- 余额不足时无法开始游戏
- 查看服务器日志了解详细错误信息

## 技术栈
- Go 1.23.0
- Protocol Buffers v2
- Gorilla WebSocket
- 金色Wild级联引擎