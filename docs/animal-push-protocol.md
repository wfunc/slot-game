# åŠ¨ç‰©æ¨é€åè®®å®ç°æ–‡æ¡£

## æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°äº†åŠ¨ç‰©æ¸¸æˆä¸­åŠ¨ç‰©è¿›å…¥/ç¦»å¼€æˆ¿é—´æ—¶çš„å®æ—¶æ¨é€åè®®å®ç°ã€‚

## åè®®å®šä¹‰

### 1. åŠ¨ç‰©è¿›å…¥æ¨é€ (m_1887_toc)

å½“æ–°åŠ¨ç‰©è¿›å…¥æˆ¿é—´æ—¶ï¼ŒæœåŠ¡å™¨ä¼šæ¨é€æ­¤æ¶ˆæ¯ç»™æˆ¿é—´å†…æ‰€æœ‰ç©å®¶ã€‚

**æ¶ˆæ¯ID**: 1887

**Protobufå®šä¹‰**:
```protobuf
// æ¨é€åŠ¨ç‰©è¿›æ¥
message m_1887_toc{
    repeated    p_route     animal  = 1; // åŠ¨ç‰©è¿›æ¥æˆ¿é—´çš„è·¯å¾„
}

message p_route{
    required    uint32      id          = 1; // å”¯ä¸€ID
    required    e_animal    bet         = 2; // åŠ¨ç‰©åå­—
    required    uint32      line_id     = 3; // è·¯çº¿
    required    uint32      point       = 4; // è·¯å¾„
    required    bool        red_state   = 5; // çº¢åŒ…çŠ¶æ€
    required    e_animal_state  status  = 6; // åŠ¨ç‰©å½“å‰çš„çŠ¶æ€
}
```

### 2. åŠ¨ç‰©ç¦»å¼€æ¨é€ (m_1888_toc)

å½“åŠ¨ç‰©ç¦»å¼€æˆ¿é—´æ—¶ï¼ŒæœåŠ¡å™¨ä¼šæ¨é€æ­¤æ¶ˆæ¯ã€‚

**æ¶ˆæ¯ID**: 1888

**Protobufå®šä¹‰**:
```protobuf
// æ¨é€åŠ¨ç‰©ç¦»å¼€
message m_1888_toc{
    required    uint32      id      = 1; // åŠ¨ç‰©ID
}
```

## ç³»ç»Ÿæ¶æ„

```
åŠ¨ç‰©æˆ¿é—´ (AnimalRoom)
    â†“ [ç”Ÿæˆ/ç§»é™¤åŠ¨ç‰©]
æ¨é€å›è°ƒ (PushCallback)
    â†“ [åˆ›å»ºæ¨é€æ¶ˆæ¯]
æ¨é€ç®¡ç†å™¨ (PushManager)
    â†“ [åºåˆ—åŒ–protobuf]
å®¢æˆ·ç«¯ç®¡ç†å™¨ (ClientManager)
    â†“ [å¹¿æ’­åˆ°æˆ¿é—´]
WebSocketå®¢æˆ·ç«¯
```

## æ ¸å¿ƒç»„ä»¶

### 1. AnimalRoom (åŠ¨ç‰©æˆ¿é—´)

- **ä½ç½®**: `/internal/game/animal/animal_room.go`
- **èŒè´£**: ç®¡ç†åŠ¨ç‰©çš„ç”Ÿæˆã€ç§»é™¤å’ŒçŠ¶æ€
- **æ¨é€è§¦å‘**:
  - `generateAnimal()` - ç”Ÿæˆæ–°åŠ¨ç‰©æ—¶è°ƒç”¨ `pushAnimalEnter()`
  - `removeAnimal()` - ç§»é™¤åŠ¨ç‰©æ—¶è°ƒç”¨ `pushAnimalLeave()`

### 2. PushManager (æ¨é€ç®¡ç†å™¨)

- **ä½ç½®**: `/internal/websocket/push_manager.go`
- **èŒè´£**: å¤„ç†protobufæ¶ˆæ¯çš„åºåˆ—åŒ–å’Œè·¯ç”±
- **ä¸»è¦æ–¹æ³•**:
  - `HandleAnimalPush()` - å¤„ç†åŠ¨ç‰©æ¨é€æ¶ˆæ¯
  - `encodeProtobufMessage()` - åºåˆ—åŒ–protobufæ¶ˆæ¯
  - `CreatePushCallback()` - åˆ›å»ºæ¨é€å›è°ƒå‡½æ•°

### 3. ClientManager (å®¢æˆ·ç«¯ç®¡ç†å™¨)

- **ä½ç½®**: `/internal/websocket/client_manager.go`
- **èŒè´£**: ç®¡ç†WebSocketå®¢æˆ·ç«¯è¿æ¥å’Œæˆ¿é—´
- **ä¸»è¦æ–¹æ³•**:
  - `JoinRoom()` - å®¢æˆ·ç«¯åŠ å…¥æˆ¿é—´
  - `LeaveRoom()` - å®¢æˆ·ç«¯ç¦»å¼€æˆ¿é—´
  - `BroadcastToRoom()` - å‘æˆ¿é—´å†…æ‰€æœ‰å®¢æˆ·ç«¯å¹¿æ’­æ¶ˆæ¯

### 4. BinaryProtocolRouter (åè®®è·¯ç”±å™¨)

- **ä½ç½®**: `/internal/websocket/binary_protocol_router.go`
- **èŒè´£**: å¤„ç†å‰ç«¯çš„äºŒè¿›åˆ¶åè®®è¯·æ±‚
- **é›†æˆç‚¹**:
  - åˆå§‹åŒ–æ—¶åˆ›å»ºé»˜è®¤åŠ¨ç‰©æˆ¿é—´
  - å¤„ç†1801å‘½ä»¤æ—¶å°†å®¢æˆ·ç«¯åŠ å…¥æˆ¿é—´
  - è‡ªåŠ¨æ¥æ”¶å¹¶è½¬å‘åŠ¨ç‰©æ¨é€æ¶ˆæ¯

## æ¶ˆæ¯æµç¨‹

### åŠ¨ç‰©ç”Ÿæˆå¹¶æ¨é€

1. **å®šæ—¶å™¨è§¦å‘ç”Ÿæˆ**
   ```go
   AnimalRoom.generateAnimal()
   ```

2. **åˆ›å»ºåŠ¨ç‰©å®ä½“**
   ```go
   newAnimal := r.generator.GenerateAnimal(excludeTypes)
   r.animals[newAnimal.ID] = newAnimal
   ```

3. **æ¨é€åŠ¨ç‰©è¿›å…¥æ¶ˆæ¯**
   ```go
   r.pushAnimalEnter(newAnimal)
   ```

4. **æ„å»ºprotobufæ¶ˆæ¯**
   ```go
   msg := &pb.M_1887Toc{
       Animal: []*pb.PRoute{route},
   }
   ```

5. **è°ƒç”¨æ¨é€å›è°ƒ**
   ```go
   r.pushCallback(&PushMessage{
       MsgID:   1887,
       Message: msg,
   })
   ```

6. **åºåˆ—åŒ–å¹¶å¹¿æ’­**
   ```go
   data, _ := proto.Marshal(message)
   clientManager.BroadcastToRoom(roomID, msgID, data)
   ```

## æµ‹è¯•æ–¹æ³•

### ä½¿ç”¨æµ‹è¯•é¡µé¢

1. æ‰“å¼€ `test/websocket_test.html`
2. ç‚¹å‡» "Connect" è¿æ¥åˆ°æœåŠ¡å™¨
3. ç‚¹å‡» "1801 - Enter Zoo" è¿›å…¥åŠ¨ç‰©æˆ¿é—´
4. è§‚å¯Ÿæ¥æ”¶æ—¥å¿—ä¸­çš„æ¨é€æ¶ˆæ¯ï¼š
   - ğŸ¦ åŠ¨ç‰©è¿›å…¥æ¨é€ (1887)
   - ğŸ¢ åŠ¨ç‰©ç¦»å¼€æ¨é€ (1888)

### æ—¥å¿—è¾“å‡ºç¤ºä¾‹

```
[PushManager] å¤„ç†åŠ¨ç‰©æ¨é€ room_id:1 msg_id:1887 zoo_type:civilian
[PushManager] æ¨é€åŠ¨ç‰©è¿›å…¥ animal_id:1 animal_type:tuzi line_id:19 point:10
[ClientManager] å‘æˆ¿é—´å¹¿æ’­æ¶ˆæ¯ room_id:1 msg_id:1887 client_count:1
```

## æ¶ˆæ¯æ ¼å¼

### äºŒè¿›åˆ¶åè®®æ ¼å¼

æœåŠ¡ç«¯æ¨é€æ¶ˆæ¯æ ¼å¼ï¼ˆ11å­—èŠ‚å¤´ + protobufæ•°æ®ï¼‰:
```
ErrorID    (2å­—èŠ‚) = 0x0000 (æˆåŠŸ)
DataSize   (2å­—èŠ‚) = protobufé•¿åº¦
DataStatus (1å­—èŠ‚) = 0x00
Flag       (4å­—èŠ‚) = 0x00000000 (æ¨é€æ¶ˆæ¯é€šå¸¸ä¸º0)
Cmd        (2å­—èŠ‚) = 0x075B (1887) æˆ– 0x0760 (1888)
Data       (nå­—èŠ‚) = protobufåºåˆ—åŒ–æ•°æ®
```

### ç¤ºä¾‹æ•°æ®

åŠ¨ç‰©è¿›å…¥æ¨é€ (1887):
```
00 00  // ErrorID = 0
00 0E  // DataSize = 14
00     // DataStatus = 0
00 00 00 00  // Flag = 0
07 5B  // Cmd = 1887
[protobufæ•°æ®]
```

## é…ç½®è¯´æ˜

### æˆ¿é—´é…ç½®

é»˜è®¤æˆ¿é—´ID: 1
é»˜è®¤æˆ¿é—´ç±»å‹: civilian (å¹³æ°‘åœº)

### åŠ¨ç‰©ç”Ÿæˆé…ç½®

- åˆå§‹åŠ¨ç‰©æ•°é‡: 15-25åª
- ç”Ÿæˆé—´éš”: 1-5ç§’
- åŠ¨ç‰©å­˜æ´»æ—¶é—´: åŸºäºè·¯å¾„ç‚¹æ•°ï¼ˆ20-45ç§’ï¼‰

## æ³¨æ„äº‹é¡¹

1. **å®¢æˆ·ç«¯è¿æ¥ç®¡ç†**: å®¢æˆ·ç«¯æ–­å¼€æ—¶éœ€è¦æ¸…ç†ä¼šè¯
2. **æˆ¿é—´ç”Ÿå‘½å‘¨æœŸ**: æˆ¿é—´ä¸ºç©ºæ—¶ä¸ä¼šè‡ªåŠ¨é”€æ¯ï¼ˆä¿æŒåŠ¨ç‰©ç»§ç»­è¿è¡Œï¼‰
3. **æ¶ˆæ¯åºåˆ—åŒ–**: ä½¿ç”¨ google.golang.org/protobuf è¿›è¡Œåºåˆ—åŒ–
4. **å¹¶å‘å®‰å…¨**: ClientManager ä½¿ç”¨è¯»å†™é”ä¿æŠ¤å¹¶å‘è®¿é—®

## åç»­ä¼˜åŒ–

1. **å¤šæˆ¿é—´æ”¯æŒ**: æ ¹æ®ç©å®¶æ•°é‡åŠ¨æ€åˆ›å»ºæˆ¿é—´
2. **æ¶ˆæ¯å‹ç¼©**: å¯¹å¤§é‡æ¨é€æ¶ˆæ¯è¿›è¡Œæ‰¹é‡å‹ç¼©
3. **æ–­çº¿é‡è¿**: æ”¯æŒå®¢æˆ·ç«¯æ–­çº¿é‡è¿åçš„çŠ¶æ€æ¢å¤
4. **æ€§èƒ½ä¼˜åŒ–**: ä½¿ç”¨å¯¹è±¡æ± å‡å°‘å†…å­˜åˆ†é…

---

æ›´æ–°æ—¶é—´: 2025-09-18
ç‰ˆæœ¬: 1.0.0