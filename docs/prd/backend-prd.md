# 推币机游戏后端系统PRD文档

## 1. 项目概述

### 1.1 产品定位
电玩城单机推币机游戏控制系统，通过老虎机中奖机制驱动推币机运作，提供震撼的游戏体验。

### 1.2 核心价值
- **游戏融合创新**：将老虎机与推币机结合，增强游戏趣味性
- **远程控制能力**：支持线上操控设备，便于运营管理
- **稳定可靠运行**：7×24小时稳定运行，故障自恢复机制

### 1.3 技术特点
- 基于Go语言的高性能后端
- 本地SQLite数据库，无需外部依赖
- 多协议通信支持（串口/WebSocket/MQTT）

## 2. 功能需求

### 2.1 核心功能模块

#### 🎰 游戏逻辑模块 [P0]
- **老虎机转轮逻辑**
  - 随机数生成算法
  - 中奖概率配置
  - 中奖组合判定
  - 奖励计算规则
  
- **推币机控制**
  - 推币动作触发
  - 推币力度控制
  - 币数统计
  
- **游戏状态管理**
  - 游戏开始/结束
  - 异常状态处理
  - 断线重连恢复

#### 🔌 硬件通信模块 [P0]
- **串口通信**
  - 推币机械臂控制
  - 投币器信号接收
  - 出币器控制
  - 灯光/音效设备控制
  
- **设备状态监控**
  - 心跳检测
  - 故障诊断
  - 自动重连

#### 💻 前端通信模块 [P0]
- **WebSocket服务**
  - 与Cocos前端实时通信
  - 游戏状态同步
  - 动画触发指令
  - 用户操作响应

#### 🌐 远程控制模块 [P0]
- **MQTT客户端**
  - 设备注册上线
  - 远程指令接收
  - 状态上报
  - 参数远程配置

#### 💾 数据管理模块 [P0]
- **游戏记录**
  - 游戏流水记录
  - 中奖记录
  - 币数变化日志
  
- **统计分析**
  - 收益统计
  - 中奖率统计
  - 设备运行统计

#### ⚙️ 配置管理模块 [P1]
- **游戏参数配置**
  - 中奖概率调整
  - 奖励倍数设置
  - 推币力度配置
  
- **系统配置**
  - 串口参数
  - 网络配置
  - MQTT连接配置

### 2.2 非功能需求

#### 性能要求
- 响应时间：游戏操作响应 < 100ms
- 并发支持：单机支持多玩家排队
- 资源占用：CPU < 30%, 内存 < 512MB

#### 可靠性要求
- 系统可用性：99.9%
- 故障恢复：自动重启，断点续传
- 数据持久化：关键数据实时保存

#### 安全性要求
- 通信加密：MQTT/WebSocket使用TLS
- 防作弊：随机数算法安全
- 访问控制：远程操作鉴权

## 3. 用户故事

### 玩家视角
- 作为玩家，我希望投币后立即开始游戏，以获得流畅体验
- 作为玩家，我希望看到炫酷的中奖动画，以增强游戏快感
- 作为玩家，我希望推币机响应及时准确，以确保公平性

### 运营方视角
- 作为运营者，我希望远程监控设备状态，以便及时维护
- 作为运营者，我希望调整游戏参数，以控制盈利率
- 作为运营者，我希望查看收益统计，以分析经营状况

### 维护方视角
- 作为维护人员，我希望快速诊断故障，以减少停机时间
- 作为维护人员，我希望系统自动恢复，以降低维护成本
- 作为维护人员，我希望查看运行日志，以追踪问题原因

## 4. 接口定义

### 4.1 WebSocket接口

#### 游戏开始
```json
// 请求
{
    "type": "game",
    "action": "start",
    "data": {
        "coins": 1,
        "player_id": "optional"
    }
}

// 响应
{
    "type": "game",
    "action": "started",
    "data": {
        "session_id": "xxx",
        "status": "spinning"
    }
}
```

#### 转轮结果
```json
// 推送
{
    "type": "game",
    "action": "spin_result",
    "data": {
        "result": [7, 7, 7],
        "win_type": "jackpot",
        "win_amount": 100,
        "push_count": 5,
        "animation": "big_win"
    }
}
```

#### 推币反馈
```json
// 推送
{
    "type": "game",
    "action": "push_feedback",
    "data": {
        "pushed_coins": 3,
        "current_coins": 45,
        "push_force": 80
    }
}
```

### 4.2 串口协议

#### 命令格式
```
命令头:参数1:参数2:...\r\n
```

#### 命令列表
| 命令 | 格式 | 说明 |
|------|------|------|
| 推币 | PUSH:力度:次数 | 触发推币动作 |
| 出币 | COIN:数量 | 控制出币器 |
| 灯光 | LIGHT:模式:颜色 | 控制灯光效果 |
| 音效 | SOUND:类型:音量 | 播放音效 |
| 状态 | STATUS | 查询设备状态 |
| 复位 | RESET | 复位所有设备 |

#### 响应格式
```
OK:命令\r\n 或 ERROR:错误码:错误信息\r\n
```

### 4.3 MQTT协议

#### 主题定义
| 主题 | 方向 | 说明 |
|------|------|------|
| device/{id}/online | 上行 | 设备上线通知 |
| device/{id}/offline | 上行 | 设备离线通知 |
| device/{id}/status | 上行 | 状态定期上报 |
| device/{id}/event | 上行 | 事件实时上报 |
| device/{id}/command | 下行 | 控制指令下发 |
| device/{id}/config | 下行 | 配置参数更新 |

#### 消息格式
```json
{
    "device_id": "SLOT-001",
    "timestamp": 1699999999,
    "type": "status/event/command/config",
    "data": {
        // 具体数据
    }
}
```

## 5. 数据模型

### 游戏记录
| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER | 主键 |
| session_id | VARCHAR(50) | 会话ID |
| start_time | DATETIME | 开始时间 |
| end_time | DATETIME | 结束时间 |
| coins_in | INTEGER | 投入币数 |
| coins_out | INTEGER | 产出币数 |
| total_wins | INTEGER | 中奖次数 |
| max_win | INTEGER | 最大中奖 |
| status | VARCHAR(20) | 游戏状态 |

### 中奖记录
| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER | 主键 |
| game_id | INTEGER | 游戏ID |
| win_type | VARCHAR(50) | 中奖类型 |
| win_pattern | VARCHAR(20) | 中奖图案 |
| win_amount | INTEGER | 中奖金额 |
| push_count | INTEGER | 推币次数 |
| trigger_time | DATETIME | 触发时间 |

### 设备状态
| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER | 主键 |
| device_type | VARCHAR(50) | 设备类型 |
| device_name | VARCHAR(100) | 设备名称 |
| status | VARCHAR(20) | 运行状态 |
| last_heartbeat | DATETIME | 最后心跳 |
| error_count | INTEGER | 错误次数 |
| error_msg | TEXT | 错误信息 |

## 6. 风险评估

### 技术风险
| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| 串口通信不稳定 | 中 | 高 | 实现重试机制、缓冲队列 |
| 游戏状态丢失 | 低 | 高 | 定期持久化、快速恢复 |
| 网络断线 | 中 | 中 | 自动重连、离线模式 |
| 硬件故障 | 低 | 高 | 故障检测、降级运行 |
| 并发冲突 | 低 | 中 | 加锁机制、队列处理 |

### 业务风险
| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| 中奖率失控 | 低 | 高 | 实时监控、自动预警 |
| 作弊行为 | 中 | 高 | 加密通信、行为检测 |
| 设备损坏 | 低 | 中 | 过载保护、异常停机 |

## 7. 验收标准

### 功能验收
- ✅ 完整游戏流程可运行
- ✅ 所有硬件设备可控制
- ✅ 前后端通信正常
- ✅ 远程管理功能可用
- ✅ 数据统计准确

### 性能验收
- ✅ 响应时间 < 100ms
- ✅ CPU占用 < 30%
- ✅ 内存使用 < 512MB
- ✅ 网络延迟 < 50ms

### 稳定性验收
- ✅ 连续运行72小时无故障
- ✅ 断电恢复正常
- ✅ 网络断线自动重连
- ✅ 硬件故障自动检测

## 8. 项目里程碑

| 阶段 | 时间 | 交付物 |
|------|------|--------|
| 项目启动 | Week 1 | 环境搭建、基础框架 |
| 核心开发 | Week 2-3 | 游戏引擎、通信模块 |
| 集成测试 | Week 3-4 | 系统集成、功能测试 |
| 优化调试 | Week 4 | 性能优化、稳定性测试 |
| 正式交付 | Week 4末 | 部署上线、文档交付 |