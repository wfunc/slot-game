<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÆ ÁñØÁãÇÂä®Áâ©Âõ≠ WebSocket ÊµãËØïÂ∑•ÂÖ∑ - ÂÆåÊï¥ÂçèËÆÆÊµãËØï</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        h1 {
            color: #333;
            text-align: center;
            font-size: 28px;
            margin-bottom: 20px;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 8px;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dc3545;
        }

        .status-indicator.connected {
            background: #28a745;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
        }

        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
        }

        .control-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .control-section {
            margin-bottom: 25px;
        }

        .control-section h3 {
            color: #667eea;
            font-size: 16px;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #f0f0f0;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 15px;
        }

        .quick-btn {
            padding: 8px;
            font-size: 12px;
        }

        .message-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            color: #666;
            font-weight: bold;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
            height: calc(100vh - 320px);
            overflow-y: auto;
        }

        .tab-content.active {
            display: block;
        }

        .message {
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            font-size: 13px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .message.sent {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-left: 4px solid #2196f3;
        }

        .message.received {
            background: linear-gradient(135deg, #f1f8e9 0%, #dcedc8 100%);
            border-left: 4px solid #8bc34a;
        }

        .message.push {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-left: 4px solid #ff9800;
        }

        .message.error {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            border-left: 4px solid #f44336;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .message-type {
            font-weight: bold;
            color: #333;
        }

        .message-time {
            color: #999;
            font-size: 11px;
        }

        .message-content {
            color: #555;
            line-height: 1.5;
        }

        .proto-fields {
            margin-top: 10px;
            padding: 10px;
            background: rgba(255,255,255,0.5);
            border-radius: 5px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
        }

        .proto-field {
            margin: 5px 0;
            padding-left: 10px;
        }

        .field-name {
            color: #2196f3;
            font-weight: bold;
        }

        .field-value {
            color: #4caf50;
        }

        .field-type {
            color: #999;
            font-size: 10px;
        }

        .game-state {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .game-state h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .state-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .state-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .state-label {
            color: #666;
            font-size: 12px;
        }

        .state-value {
            color: #333;
            font-weight: bold;
            font-size: 12px;
        }

        .animal-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
        }

        .animal-item {
            display: flex;
            justify-content: space-between;
            padding: 5px;
            margin-bottom: 5px;
            background: #f5f5f5;
            border-radius: 3px;
        }

        .animal-name {
            font-weight: bold;
            color: #667eea;
        }

        .animal-info {
            color: #666;
            font-size: 11px;
        }

        .skill-container {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .skill-item {
            flex: 1;
            text-align: center;
            padding: 8px;
            background: #f0f0f0;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .skill-item:hover {
            background: #667eea;
            color: white;
        }

        .skill-item.active {
            background: #4caf50;
            color: white;
        }

        .skill-count {
            font-size: 10px;
            margin-top: 3px;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .stat-box {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
        }

        .debug-panel {
            margin-top: 20px;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 8px;
        }

        .debug-toggle {
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .debug-content {
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 11px;
            background: white;
            padding: 10px;
            border-radius: 5px;
        }

        .hex-dump {
            word-break: break-all;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü¶Å ÁñØÁãÇÂä®Áâ©Âõ≠ WebSocket ÊµãËØïÂ∑•ÂÖ∑ üêò</h1>
            <div class="status-bar">
                <div class="status">
                    <div class="status-indicator" id="statusIndicator"></div>
                    <span id="statusText">Êú™ËøûÊé•</span>
                </div>
                <div id="connectionInfo">
                    <span id="connectionTime"></span>
                    <span id="roomInfo" style="margin-left: 20px;"></span>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="control-panel">
                <!-- ËøûÊé•ÊéßÂà∂ -->
                <div class="control-section">
                    <h3>üîå ËøûÊé•ËÆæÁΩÆ</h3>
                    <div class="input-group">
                        <label>WebSocket URL</label>
                        <input type="text" id="wsUrl" value="ws://localhost:8080/ws/game?game=animal" placeholder="ws://localhost:8080/ws/game?game=animal">
                    </div>
                    <button id="connectBtn" class="btn btn-primary" onclick="connect()">ËøûÊé•ÊúçÂä°Âô®</button>
                    <button id="disconnectBtn" class="btn btn-danger" onclick="disconnect()" disabled>Êñ≠ÂºÄËøûÊé•</button>
                </div>

                <!-- ÊàøÈó¥ÊéßÂà∂ -->
                <div class="control-section">
                    <h3>üè† ÊàøÈó¥ÁÆ°ÁêÜ</h3>
                    <div class="input-group">
                        <label>Âú∫Ê¨°Á±ªÂûã</label>
                        <select id="zooType">
                            <option value="1">Âπ≥Ê∞ëÂú∫</option>
                            <option value="2">Â∞èËµÑÂú∫</option>
                            <option value="3">ÂØåË±™Âú∫</option>
                            <option value="4">ÈªÑÈáëÂú∫</option>
                            <option value="5">ÈíªÁü≥Âú∫</option>
                            <option value="6">Âçï‰∫∫Âú∫</option>
                            <option value="7">‰ΩìÈ™åÂú∫</option>
                        </select>
                    </div>
                    <button class="btn btn-success" onclick="sendEnterRoom()">ËøõÂÖ•ÊàøÈó¥ (1801)</button>
                    <button class="btn btn-warning" onclick="sendLeaveRoom()">Á¶ªÂºÄÊàøÈó¥ (1802)</button>
                    <button class="btn btn-info" onclick="sendGetZooInfo()">Ëé∑ÂèñÂú∫Ê¨°‰ø°ÊÅØ (1807)</button>
                </div>

                <!-- Â∞ÑÂáªÊéßÂà∂ -->
                <div class="control-section">
                    <h3>üéØ Â∞ÑÂáªÊéßÂà∂</h3>
                    <div class="input-group">
                        <label>‰∏ãÊ≥®ÈáëÈ¢ù</label>
                        <select id="betAmount">
                            <option value="10">10</option>
                            <option value="50">50</option>
                            <option value="100" selected>100</option>
                            <option value="200">200</option>
                            <option value="500">500</option>
                            <option value="1000">1000</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>ÁõÆÊ†áÂä®Áâ©ID</label>
                        <input type="number" id="targetAnimalId" value="1" min="1">
                    </div>
                    <button class="btn btn-danger" onclick="sendFireBullet()">ÂèëÂ∞ÑÂ≠êÂºπ (1815)</button>
                    <button class="btn btn-warning" onclick="sendBet()">‰∏ãÊ≥®ÊâìÂáª (1803)</button>
                </div>

                <!-- ÊäÄËÉΩÊéßÂà∂ -->
                <div class="control-section">
                    <h3>‚ö° ÊäÄËÉΩÁ≥ªÁªü</h3>
                    <div class="skill-container">
                        <div class="skill-item" onclick="useSkill(1)">
                            ‚ùÑÔ∏è ÂÜ∞ÂÜª
                            <div class="skill-count" id="skill_1">0</div>
                        </div>
                        <div class="skill-item" onclick="useSkill(2)">
                            üéØ ÈîÅÂÆö
                            <div class="skill-count" id="skill_2">0</div>
                        </div>
                        <div class="skill-item" onclick="useSkill(3)">
                            ‚ú® ÂÄçÁéá
                            <div class="skill-count" id="skill_3">0</div>
                        </div>
                    </div>
                    <div class="quick-actions" style="margin-top: 10px;">
                        <button class="btn quick-btn btn-info" onclick="sendBuySkill(1)">Ë¥≠‰π∞ÂÜ∞ÂÜª</button>
                        <button class="btn quick-btn btn-info" onclick="sendBuySkill(2)">Ë¥≠‰π∞ÈîÅÂÆö</button>
                        <button class="btn quick-btn btn-info" onclick="sendBuySkill(3)">Ë¥≠‰π∞ÂÄçÁéá</button>
                        <button class="btn quick-btn btn-info" onclick="sendGetToolsPrice()">Êü•ËØ¢‰ª∑Ê†º</button>
                    </div>
                </div>

                <!-- Êï∞ÊçÆÊü•ËØ¢ -->
                <div class="control-section">
                    <h3>üìä Êï∞ÊçÆÊü•ËØ¢</h3>
                    <button class="btn btn-info" onclick="sendGetRecord()">Ê∏∏ÊàèËÆ∞ÂΩï (1804)</button>
                    <button class="btn btn-info" onclick="sendGetReward()">Â§ßÂ•ñËÆ∞ÂΩï (1805)</button>
                    <button class="btn btn-info" onclick="sendGetCJLog()">ÂΩ©ÈáëËÆ∞ÂΩï (1812)</button>
                </div>

                <!-- Âø´ÈÄüÊµãËØï -->
                <div class="control-section">
                    <h3>üöÄ Âø´ÈÄüÊµãËØï</h3>
                    <div class="quick-actions">
                        <button class="btn quick-btn btn-success" onclick="quickTest('enter')">ËøõÊàøÊµãËØï</button>
                        <button class="btn quick-btn btn-success" onclick="quickTest('shoot')">Â∞ÑÂáªÊµãËØï</button>
                        <button class="btn quick-btn btn-success" onclick="quickTest('skill')">ÊäÄËÉΩÊµãËØï</button>
                        <button class="btn quick-btn btn-success" onclick="quickTest('full')">ÂÆåÊï¥ÊµÅÁ®ã</button>
                    </div>
                </div>

                <!-- Ê∏∏ÊàèÁä∂ÊÄÅ -->
                <div class="game-state">
                    <h4>üéÆ Ê∏∏ÊàèÁä∂ÊÄÅ</h4>
                    <div class="state-grid">
                        <div class="state-item">
                            <span class="state-label">ÈáëÂ∏Å:</span>
                            <span class="state-value" id="playerBalance">0</span>
                        </div>
                        <div class="state-item">
                            <span class="state-label">‰ΩìÈ™åÂ∏Å:</span>
                            <span class="state-value" id="freeGold">0</span>
                        </div>
                        <div class="state-item">
                            <span class="state-label">Á¥ØËÆ°Ëµ¢Âèñ:</span>
                            <span class="state-value" id="totalWin">0</span>
                        </div>
                        <div class="state-item">
                            <span class="state-label">ÂΩ©ÈáëÊ±†:</span>
                            <span class="state-value" id="jackpot">0</span>
                        </div>
                    </div>
                    <div class="animal-list" id="animalList">
                        <div style="text-align: center; color: #999;">ÊöÇÊó†Âä®Áâ©</div>
                    </div>
                </div>

                <!-- ÁªüËÆ°‰ø°ÊÅØ -->
                <div class="stats-container">
                    <div class="stat-box">
                        <div class="stat-value" id="sentCount">0</div>
                        <div class="stat-label">ÂèëÈÄÅ</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="receivedCount">0</div>
                        <div class="stat-label">Êé•Êî∂</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="pushCount">0</div>
                        <div class="stat-label">Êé®ÈÄÅ</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="errorCount">0</div>
                        <div class="stat-label">ÈîôËØØ</div>
                    </div>
                </div>
            </div>

            <div class="message-panel">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('all')">ÂÖ®ÈÉ®Ê∂àÊÅØ</button>
                    <button class="tab" onclick="switchTab('sent')">ÂèëÈÄÅÊ∂àÊÅØ</button>
                    <button class="tab" onclick="switchTab('received')">Êé•Êî∂ÂìçÂ∫î</button>
                    <button class="tab" onclick="switchTab('push')">Êé®ÈÄÅÊ∂àÊÅØ</button>
                    <button class="tab" onclick="switchTab('debug')">Ë∞ÉËØï‰ø°ÊÅØ</button>
                </div>

                <div class="tab-content active" id="tab-all"></div>
                <div class="tab-content" id="tab-sent"></div>
                <div class="tab-content" id="tab-received"></div>
                <div class="tab-content" id="tab-push"></div>
                <div class="tab-content" id="tab-debug"></div>
            </div>
        </div>
    </div>

    <script>
        // WebSocketËøûÊé•
        let ws = null;
        let connectionStartTime = null;

        // ÁªüËÆ°ËÆ°Êï∞
        let sentCount = 0;
        let receivedCount = 0;
        let pushCount = 0;
        let errorCount = 0;

        // Ê∏∏ÊàèÁä∂ÊÄÅ
        let gameState = {
            roomType: 0,
            animals: new Map(),
            players: new Map(),
            skills: new Map(),
            balance: 0,
            freeGold: 0,
            totalWin: 0,
            jackpot: 0,
            betValues: []
        };

        // Ê∂àÊÅØÁ±ªÂûãÊò†Â∞Ñ
        const MESSAGE_TYPES = {
            // ÂÆ¢Êà∑Á´ØËØ∑Ê±Ç
            1801: 'ËøõÂÖ•ÊàøÈó¥',
            1802: 'Á¶ªÂºÄÊàøÈó¥',
            1803: '‰∏ãÊ≥®ÊâìÂáª',
            1804: 'Êü•ÁúãËÆ∞ÂΩï',
            1805: 'Êü•ÁúãÂ§ßÂ•ñ',
            1806: '‰ΩøÁî®ÊäÄËÉΩ',
            1807: 'Ëé∑ÂèñÂú∫Ê¨°',
            1808: 'Ë¥≠‰π∞ÈÅìÂÖ∑',
            1809: 'Ëé∑Âèñ‰ª∑Ê†º',
            1812: 'ÂΩ©ÈáëËÆ∞ÂΩï',
            1815: 'ÂèëÂ∞ÑÂ≠êÂºπ',

            // Ê¥ªÂä®Âú∫
            1871: 'ËøõÂÖ•Ê¥ªÂä®',
            1872: 'ÊâìÊ¥ªÂä®Âä®Áâ©',
            1873: 'Ëé∑ÂèñÊéíË°å',
            1879: 'ËßÇÊàòËßÜËßí',

            // ÊúçÂä°Âô®Êé®ÈÄÅ
            1810: 'Êé®ÈÄÅÂΩ©Èáë',
            1811: 'ÂΩ©Èáë‰∏≠Â•ñ',
            1813: '‰∏ÄÂáªÂøÖÊùÄ',
            1814: 'Ê∏ÖÈô§ÂøÖÊùÄ',
            1882: '‰ΩøÁî®ÊäÄËÉΩ',
            1883: 'Âä®Áâ©È¢ÑÂëä',
            1884: 'Âä®Áâ©Ê≠ª‰∫°',
            1885: 'Áé©ÂÆ∂Á¶ªÂºÄ',
            1886: 'Áé©ÂÆ∂ËøõÂÖ•',
            1887: 'Âä®Áâ©ËøõÂÖ•',
            1888: 'Âä®Áâ©Á¶ªÂºÄ',
            1889: 'Ê¥ªÂä®ÂπøÊí≠',
            1899: 'ÊâìÂáªÂä®Áâ©',

            // Ê¥ªÂä®Êé®ÈÄÅ
            1874: 'Ê¥ªÂä®Âä®Áâ©Á¶ªÂºÄ',
            1875: 'Ê¥ªÂä®ÁªìÊùü',
            1876: 'Ê¥ªÂä®Âä®Áâ©ËøõÂÖ•',
            1877: 'Ê¥ªÂä®Âä®Áâ©Ê≠ª‰∫°',
            1878: 'Ê¥ªÂä®Áä∂ÊÄÅ',
            1880: 'Ê¥ªÂä®ÊéíË°å',
            1881: 'Ê¥ªÂä®ÁÇπÂáª'
        };

        // Âä®Áâ©Á±ªÂûãÊò†Â∞Ñ
        const ANIMAL_TYPES = {
            0: 'ÈáëË±Ü',
            1: '‰πåÈæü',
            2: 'ÂÖ¨È∏°',
            3: 'ÊñóÁâõÁä¨',
            4: 'Èáë‰∏ùÁå¥',
            5: 'ÁüÆÈ©¨',
            6: 'Â•∂Áâõ',
            7: 'ÁÜäÁå´',
            8: 'Ê≤≥È©¨',
            9: 'ÁãÆÂ≠ê',
            10: 'Â§ßË±°',
            11: 'ÁöÆÂç°‰∏ò',
            12: 'ÁÇ∏Âºπ‰∫∫',
            13: 'ËÄÅËôé',
            14: 'ÁæäÈ©º',
            15: 'ÁÜä',
            16: 'ÂÖîÂ≠ê',
            17: 'È©¥',
            18: 'Ë±πÂ≠ê',
            19: 'Áå™',
            20: 'Ê≤≥È©¨'
        };

        // ÊäÄËÉΩÁ±ªÂûãÊò†Â∞Ñ
        const SKILL_TYPES = {
            1: 'ÂÜ∞ÂÜªÊäÄËÉΩ',
            2: 'ÈîÅÂÆöÁõÆÊ†á',
            3: 'ÂÄçÁéáÊèêÂçá'
        };

        // Âú∫Ê¨°Á±ªÂûãÊò†Â∞Ñ
        const ZOO_TYPES = {
            1: 'Âπ≥Ê∞ëÂú∫',
            2: 'Â∞èËµÑÂú∫',
            3: 'ÂØåË±™Âú∫',
            4: 'ÈªÑÈáëÂú∫',
            5: 'ÈíªÁü≥Âú∫',
            6: 'Âçï‰∫∫Âú∫',
            7: '‰ΩìÈ™åÂú∫'
        };

        // ProtobufÁºñËß£Á†Å
        class ProtobufCodec {
            static encodeVarint(value) {
                const bytes = [];
                while (value > 0x7f) {
                    bytes.push((value & 0x7f) | 0x80);
                    value >>>= 7;
                }
                bytes.push(value & 0x7f);
                return bytes;
            }

            static decodeVarint(bytes, offset = 0) {
                let value = 0;
                let shift = 0;
                while (offset < bytes.length) {
                    const byte = bytes[offset++];
                    value |= (byte & 0x7f) << shift;
                    if ((byte & 0x80) === 0) {
                        return { value, offset };
                    }
                    shift += 7;
                }
                throw new Error('Varint too long');
            }

            static encodeMessage(msgId, fields = {}) {
                const data = [];

                // ÁºñÁ†ÅÂ≠óÊÆµ
                for (const [fieldNum, value] of Object.entries(fields)) {
                    const tag = (parseInt(fieldNum) << 3) | 0; // VARINTÁ±ªÂûã
                    data.push(...this.encodeVarint(tag));

                    if (typeof value === 'number') {
                        data.push(...this.encodeVarint(value));
                    } else if (typeof value === 'string') {
                        const strBytes = new TextEncoder().encode(value);
                        const lenTag = (parseInt(fieldNum) << 3) | 2; // LENGTH_DELIMITED
                        data.push(lenTag);
                        data.push(...this.encodeVarint(strBytes.length));
                        data.push(...strBytes);
                    } else if (value instanceof Uint8Array) {
                        const lenTag = (parseInt(fieldNum) << 3) | 2;
                        data.push(lenTag);
                        data.push(...this.encodeVarint(value.length));
                        data.push(...value);
                    }
                }

                // ÊûÑÂª∫ÂÆåÊï¥Ê∂àÊÅØ
                const protoData = new Uint8Array(data);
                const totalLength = 2 + protoData.length;
                const buffer = new ArrayBuffer(4 + totalLength);
                const view = new DataView(buffer);
                const bytes = new Uint8Array(buffer);

                view.setUint32(0, totalLength, false); // ÈïøÂ∫¶
                view.setUint16(4, msgId, false); // Ê∂àÊÅØID
                bytes.set(protoData, 6);

                return buffer;
            }

            static decodeMessage(buffer) {
                const bytes = new Uint8Array(buffer);
                const view = new DataView(buffer);

                if (bytes.length < 6) {
                    return { msgId: 0, fields: {}, error: 'Ê∂àÊÅØÂ§™Áü≠' };
                }

                const length = view.getUint32(0, false);
                const msgId = view.getUint16(4, false);
                const dataBytes = bytes.slice(6);

                // Ëß£ÊûêÂ≠óÊÆµ
                const fields = {};
                let offset = 0;

                while (offset < dataBytes.length) {
                    const tagResult = this.decodeVarint(dataBytes, offset);
                    if (!tagResult) break;

                    const tag = tagResult.value;
                    offset = tagResult.offset;

                    const fieldNum = tag >>> 3;
                    const wireType = tag & 7;

                    if (wireType === 0) { // VARINT
                        const result = this.decodeVarint(dataBytes, offset);
                        fields[fieldNum] = result.value;
                        offset = result.offset;
                    } else if (wireType === 2) { // LENGTH_DELIMITED
                        const lenResult = this.decodeVarint(dataBytes, offset);
                        const len = lenResult.value;
                        offset = lenResult.offset;

                        const data = dataBytes.slice(offset, offset + len);
                        fields[fieldNum] = data;
                        offset += len;
                    }
                }

                return { msgId, fields, length };
            }
        }

        // ËøûÊé•WebSocket
        function connect() {
            const url = document.getElementById('wsUrl').value;

            if (!url) {
                showError('ËØ∑ËæìÂÖ•WebSocket URL');
                return;
            }

            try {
                ws = new WebSocket(url);
                ws.binaryType = 'arraybuffer';

                ws.onopen = () => {
                    connectionStartTime = Date.now();
                    updateStatus(true);
                    addMessage('all', '‚úÖ ËøûÊé•ÊàêÂäü', 'received');
                };

                ws.onmessage = (event) => {
                    if (event.data instanceof ArrayBuffer) {
                        handleMessage(event.data);
                    }
                };

                ws.onerror = (event) => {
                    errorCount++;
                    updateStats();
                    addMessage('all', '‚ùå ËøûÊé•ÈîôËØØ', 'error');
                };

                ws.onclose = (event) => {
                    connectionStartTime = null;
                    updateStatus(false);
                    addMessage('all', `‚ö†Ô∏è ËøûÊé•ÂÖ≥Èó≠ (${event.code})`, 'error');
                };

            } catch (error) {
                showError('ËøûÊé•Â§±Ë¥•: ' + error.message);
            }
        }

        // Êñ≠ÂºÄËøûÊé•
        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        // ÂèëÈÄÅÊ∂àÊÅØ
        function sendMessage(msgId, fields = {}) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                showError('WebSocketÊú™ËøûÊé•');
                return;
            }

            const buffer = ProtobufCodec.encodeMessage(msgId, fields);
            ws.send(buffer);

            sentCount++;
            updateStats();

            const msgName = MESSAGE_TYPES[msgId] || `Ê∂àÊÅØ${msgId}`;
            addMessage('sent', `üì§ [${msgId}] ${msgName}`, 'sent', fields);
        }

        // Â§ÑÁêÜÊé•Êî∂ÁöÑÊ∂àÊÅØ
        function handleMessage(buffer) {
            const decoded = ProtobufCodec.decodeMessage(buffer);
            const msgName = MESSAGE_TYPES[decoded.msgId] || `Ê∂àÊÅØ${decoded.msgId}`;

            // Âà§Êñ≠ÊòØÊé®ÈÄÅËøòÊòØÂìçÂ∫î
            const isPush = decoded.msgId >= 1810 && decoded.msgId !== 1812;

            if (isPush) {
                pushCount++;
                addMessage('push', `üì• [${decoded.msgId}] ${msgName}`, 'push', decoded.fields);
                handlePushMessage(decoded.msgId, decoded.fields);
            } else {
                receivedCount++;
                addMessage('received', `üì• [${decoded.msgId}] ${msgName}`, 'received', decoded.fields);
                handleResponse(decoded.msgId, decoded.fields);
            }

            updateStats();
        }

        // Â§ÑÁêÜÂìçÂ∫îÊ∂àÊÅØ
        function handleResponse(msgId, fields) {
            switch(msgId) {
                case 1801: // ËøõÂÖ•ÊàøÈó¥ÂìçÂ∫î
                    handleEnterRoomResponse(fields);
                    break;
                case 1802: // Á¶ªÂºÄÊàøÈó¥ÂìçÂ∫î
                    handleLeaveRoomResponse(fields);
                    break;
                case 1803: // ‰∏ãÊ≥®ÂìçÂ∫î
                    handleBetResponse(fields);
                    break;
                case 1806: // ‰ΩøÁî®ÊäÄËÉΩÂìçÂ∫î
                    handleUseSkillResponse(fields);
                    break;
                case 1815: // ÂèëÂ∞ÑÂ≠êÂºπÂìçÂ∫î
                    handleFireBulletResponse(fields);
                    break;
            }
        }

        // Â§ÑÁêÜÊé®ÈÄÅÊ∂àÊÅØ
        function handlePushMessage(msgId, fields) {
            switch(msgId) {
                case 1887: // Âä®Áâ©ËøõÂÖ•
                    handleAnimalEnter(fields);
                    break;
                case 1888: // Âä®Áâ©Á¶ªÂºÄ
                    handleAnimalLeave(fields);
                    break;
                case 1884: // Âä®Áâ©Ê≠ª‰∫°
                    handleAnimalDie(fields);
                    break;
                case 1810: // Êé®ÈÄÅÂΩ©Èáë
                    handleJackpot(fields);
                    break;
            }
        }

        // Â§ÑÁêÜËøõÂÖ•ÊàøÈó¥ÂìçÂ∫î
        function handleEnterRoomResponse(fields) {
            // Êõ¥Êñ∞Ê∏∏ÊàèÁä∂ÊÄÅ
            if (fields[1]) { // bet_val
                gameState.betValues = Array.isArray(fields[1]) ? fields[1] : [fields[1]];
            }
            if (fields[9]) { // free_gold
                gameState.freeGold = fields[9];
                document.getElementById('freeGold').textContent = fields[9];
            }
            if (fields[10]) { // ÂΩ©Èáë
                const cj = new TextDecoder().decode(fields[10]);
                gameState.jackpot = cj;
                document.getElementById('jackpot').textContent = cj;
            }

            updateRoomInfo();
        }

        // Â§ÑÁêÜÁ¶ªÂºÄÊàøÈó¥ÂìçÂ∫î
        function handleLeaveRoomResponse(fields) {
            if (fields[1]) { // total_win
                gameState.totalWin = fields[1];
                document.getElementById('totalWin').textContent = fields[1];
            }

            // Ê∏ÖÁ©∫Âä®Áâ©ÂàóË°®
            gameState.animals.clear();
            updateAnimalList();
        }

        // Â§ÑÁêÜ‰∏ãÊ≥®ÂìçÂ∫î
        function handleBetResponse(fields) {
            if (fields[1]) { // balance
                gameState.balance = fields[1];
                document.getElementById('playerBalance').textContent = fields[1];
            }
            if (fields[6]) { // total_win
                gameState.totalWin = fields[6];
                document.getElementById('totalWin').textContent = fields[6];
            }
        }

        // Â§ÑÁêÜÂèëÂ∞ÑÂ≠êÂºπÂìçÂ∫î
        function handleFireBulletResponse(fields) {
            if (fields[2]) { // balance
                gameState.balance = fields[2];
                document.getElementById('playerBalance').textContent = fields[2];
            }
        }

        // Â§ÑÁêÜ‰ΩøÁî®ÊäÄËÉΩÂìçÂ∫î
        function handleUseSkillResponse(fields) {
            // Êõ¥Êñ∞ÊäÄËÉΩÊòæÁ§∫
            updateSkillDisplay();
        }

        // Â§ÑÁêÜÂä®Áâ©ËøõÂÖ•
        function handleAnimalEnter(fields) {
            if (fields[1]) { // animals
                // Ëß£ÊûêÂä®Áâ©Êï∞ÊçÆ
                updateAnimalList();
            }
        }

        // Â§ÑÁêÜÂä®Áâ©Á¶ªÂºÄ
        function handleAnimalLeave(fields) {
            if (fields[1]) { // id
                gameState.animals.delete(fields[1]);
                updateAnimalList();
            }
        }

        // Â§ÑÁêÜÂä®Áâ©Ê≠ª‰∫°
        function handleAnimalDie(fields) {
            if (fields[3]) { // ids
                // Â§ÑÁêÜÊ≠ª‰∫°ÁöÑÂä®Áâ©ÂàóË°®
                updateAnimalList();
            }
        }

        // Â§ÑÁêÜÂΩ©ÈáëÊé®ÈÄÅ
        function handleJackpot(fields) {
            if (fields[1]) { // bonus
                const bonus = new TextDecoder().decode(fields[1]);
                gameState.jackpot = bonus;
                document.getElementById('jackpot').textContent = bonus;
            }
        }

        // ÂèëÈÄÅËøõÂÖ•ÊàøÈó¥
        function sendEnterRoom() {
            const zooType = parseInt(document.getElementById('zooType').value);
            sendMessage(1801, { 1: zooType });
        }

        // ÂèëÈÄÅÁ¶ªÂºÄÊàøÈó¥
        function sendLeaveRoom() {
            sendMessage(1802, {});
        }

        // ÂèëÈÄÅÂèëÂ∞ÑÂ≠êÂºπ
        function sendFireBullet() {
            const betVal = parseInt(document.getElementById('betAmount').value);
            sendMessage(1815, { 1: betVal });
        }

        // ÂèëÈÄÅ‰∏ãÊ≥®
        function sendBet() {
            const targetId = parseInt(document.getElementById('targetAnimalId').value);
            sendMessage(1803, { 1: targetId });
        }

        // ‰ΩøÁî®ÊäÄËÉΩ
        function useSkill(skillType) {
            sendMessage(1806, { 1: skillType });
        }

        // ÂèëÈÄÅË¥≠‰π∞ÊäÄËÉΩ
        function sendBuySkill(skillType) {
            sendMessage(1808, { 1: skillType });
        }

        // ÂèëÈÄÅËé∑ÂèñÂú∫Ê¨°‰ø°ÊÅØ
        function sendGetZooInfo() {
            sendMessage(1807, {});
        }

        // ÂèëÈÄÅËé∑ÂèñËÆ∞ÂΩï
        function sendGetRecord() {
            sendMessage(1804, { 1: 1, 2: 10 });
        }

        // ÂèëÈÄÅËé∑ÂèñÂ§ßÂ•ñ
        function sendGetReward() {
            sendMessage(1805, {});
        }

        // ÂèëÈÄÅËé∑ÂèñÂΩ©ÈáëËÆ∞ÂΩï
        function sendGetCJLog() {
            sendMessage(1812, {});
        }

        // ÂèëÈÄÅËé∑ÂèñÈÅìÂÖ∑‰ª∑Ê†º
        function sendGetToolsPrice() {
            sendMessage(1809, {});
        }

        // Âø´ÈÄüÊµãËØï
        function quickTest(type) {
            switch(type) {
                case 'enter':
                    sendEnterRoom();
                    break;
                case 'shoot':
                    sendEnterRoom();
                    setTimeout(() => sendFireBullet(), 500);
                    setTimeout(() => sendBet(), 1000);
                    break;
                case 'skill':
                    sendEnterRoom();
                    setTimeout(() => sendBuySkill(1), 500);
                    setTimeout(() => useSkill(1), 1000);
                    break;
                case 'full':
                    sendEnterRoom();
                    setTimeout(() => sendFireBullet(), 1000);
                    setTimeout(() => sendBet(), 2000);
                    setTimeout(() => sendBuySkill(1), 3000);
                    setTimeout(() => useSkill(1), 4000);
                    setTimeout(() => sendLeaveRoom(), 10000);
                    break;
            }
        }

        // Ê∑ªÂä†Ê∂àÊÅØÂà∞ÁïåÈù¢
        function addMessage(tab, title, type, data = {}) {
            const time = new Date().toLocaleTimeString();
            const message = document.createElement('div');
            message.className = `message ${type}`;

            let content = `
                <div class="message-header">
                    <span class="message-type">${title}</span>
                    <span class="message-time">${time}</span>
                </div>
            `;

            if (Object.keys(data).length > 0) {
                content += '<div class="proto-fields">';
                for (const [key, value] of Object.entries(data)) {
                    content += `
                        <div class="proto-field">
                            <span class="field-name">field_${key}</span>:
                            <span class="field-value">${formatFieldValue(value)}</span>
                        </div>
                    `;
                }
                content += '</div>';
            }

            message.innerHTML = content;

            // Ê∑ªÂä†Âà∞ÊåáÂÆöÊ†áÁ≠æÈ°µ
            if (tab === 'all' || tab === type) {
                document.getElementById(`tab-${tab}`).insertBefore(
                    message,
                    document.getElementById(`tab-${tab}`).firstChild
                );
            }

            // ÊÄªÊòØÊ∑ªÂä†Âà∞ÂÖ®ÈÉ®Ê†áÁ≠æÈ°µ
            if (tab !== 'all') {
                const allMessage = message.cloneNode(true);
                document.getElementById('tab-all').insertBefore(
                    allMessage,
                    document.getElementById('tab-all').firstChild
                );
            }
        }

        // Ê†ºÂºèÂåñÂ≠óÊÆµÂÄº
        function formatFieldValue(value) {
            if (value instanceof Uint8Array) {
                // Â∞ùËØï‰Ωú‰∏∫Â≠óÁ¨¶‰∏≤Ëß£Á†Å
                try {
                    return new TextDecoder().decode(value);
                } catch {
                    return `[${value.length} bytes]`;
                }
            } else if (Array.isArray(value)) {
                return `[${value.join(', ')}]`;
            } else if (typeof value === 'object') {
                return JSON.stringify(value);
            }
            return value;
        }

        // Êõ¥Êñ∞Áä∂ÊÄÅÊ†è
        function updateStatus(connected) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');

            if (connected) {
                indicator.classList.add('connected');
                text.textContent = 'Â∑≤ËøûÊé•';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            } else {
                indicator.classList.remove('connected');
                text.textContent = 'Êú™ËøûÊé•';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            }
        }

        // Êõ¥Êñ∞ÁªüËÆ°
        function updateStats() {
            document.getElementById('sentCount').textContent = sentCount;
            document.getElementById('receivedCount').textContent = receivedCount;
            document.getElementById('pushCount').textContent = pushCount;
            document.getElementById('errorCount').textContent = errorCount;
        }

        // Êõ¥Êñ∞ÊàøÈó¥‰ø°ÊÅØ
        function updateRoomInfo() {
            const roomType = ZOO_TYPES[gameState.roomType] || 'Êú™Áü•';
            document.getElementById('roomInfo').textContent = `ÊàøÈó¥: ${roomType}`;
        }

        // Êõ¥Êñ∞Âä®Áâ©ÂàóË°®
        function updateAnimalList() {
            const list = document.getElementById('animalList');
            if (gameState.animals.size === 0) {
                list.innerHTML = '<div style="text-align: center; color: #999;">ÊöÇÊó†Âä®Áâ©</div>';
            } else {
                list.innerHTML = '';
                gameState.animals.forEach((animal, id) => {
                    const item = document.createElement('div');
                    item.className = 'animal-item';
                    item.innerHTML = `
                        <span class="animal-name">${ANIMAL_TYPES[animal.type] || 'Êú™Áü•'}</span>
                        <span class="animal-info">ID: ${id} | Á∫øË∑Ø: ${animal.line}</span>
                    `;
                    list.appendChild(item);
                });
            }
        }

        // Êõ¥Êñ∞ÊäÄËÉΩÊòæÁ§∫
        function updateSkillDisplay() {
            gameState.skills.forEach((skill, type) => {
                const element = document.getElementById(`skill_${type}`);
                if (element) {
                    element.textContent = skill.count || 0;
                }
            });
        }

        // ÂàáÊç¢Ê†áÁ≠æÈ°µ
        function switchTab(tabName) {
            // ÂàáÊç¢Ê†áÁ≠æÊåâÈíÆÁä∂ÊÄÅ
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // ÂàáÊç¢ÂÜÖÂÆπÊòæÁ§∫
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        // ÊòæÁ§∫ÈîôËØØ
        function showError(message) {
            alert(message);
        }

        // Êõ¥Êñ∞ËøûÊé•Êó∂Èó¥
        setInterval(() => {
            if (connectionStartTime) {
                const elapsed = Math.floor((Date.now() - connectionStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('connectionTime').textContent =
                    `ËøûÊé•Êó∂Èïø: ${minutes}ÂàÜ${seconds}Áßí`;
            } else {
                document.getElementById('connectionTime').textContent = '';
            }
        }, 1000);
    </script>
</body>
</html>