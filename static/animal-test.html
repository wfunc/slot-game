<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ® ç–¯ç‹‚åŠ¨ç‰©å›­ WebSocket æµ‹è¯•å·¥å…· - å®Œæ•´åè®®æµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        h1 {
            color: #333;
            text-align: center;
            font-size: 28px;
            margin-bottom: 20px;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 8px;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dc3545;
        }

        .status-indicator.connected {
            background: #28a745;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
        }

        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
        }

        .control-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .control-section {
            margin-bottom: 25px;
        }

        .control-section h3 {
            color: #667eea;
            font-size: 16px;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #f0f0f0;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 15px;
        }

        .quick-btn {
            padding: 8px;
            font-size: 12px;
        }

        .message-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            color: #666;
            font-weight: bold;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
            height: calc(100vh - 320px);
            overflow-y: auto;
        }

        .tab-content.active {
            display: block;
        }

        .message {
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            font-size: 13px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .message.sent {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-left: 4px solid #2196f3;
        }

        .message.received {
            background: linear-gradient(135deg, #f1f8e9 0%, #dcedc8 100%);
            border-left: 4px solid #8bc34a;
        }

        .message.push {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-left: 4px solid #ff9800;
        }

        .message.error {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            border-left: 4px solid #f44336;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .message-type {
            font-weight: bold;
            color: #333;
        }

        .message-time {
            color: #999;
            font-size: 11px;
        }

        .message-content {
            color: #555;
            line-height: 1.5;
        }

        .proto-fields {
            margin-top: 10px;
            padding: 10px;
            background: rgba(255,255,255,0.5);
            border-radius: 5px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
        }

        .proto-field {
            margin: 5px 0;
            padding-left: 10px;
        }

        .field-name {
            color: #2196f3;
            font-weight: bold;
        }

        .field-value {
            color: #4caf50;
        }

        .field-type {
            color: #999;
            font-size: 10px;
        }

        .game-state {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .game-state h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .state-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .state-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .state-label {
            color: #666;
            font-size: 12px;
        }

        .state-value {
            color: #333;
            font-weight: bold;
            font-size: 12px;
        }

        .animal-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
        }

        .animal-item {
            display: flex;
            justify-content: space-between;
            padding: 5px;
            margin-bottom: 5px;
            background: #f5f5f5;
            border-radius: 3px;
        }

        .animal-name {
            font-weight: bold;
            color: #667eea;
        }

        .animal-info {
            color: #666;
            font-size: 11px;
        }

        .skill-container {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .skill-item {
            flex: 1;
            text-align: center;
            padding: 8px;
            background: #f0f0f0;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .skill-item:hover {
            background: #667eea;
            color: white;
        }

        .skill-item.active {
            background: #4caf50;
            color: white;
        }

        .skill-count {
            font-size: 10px;
            margin-top: 3px;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .stat-box {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
        }

        .debug-panel {
            margin-top: 20px;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 8px;
        }

        .debug-toggle {
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .debug-content {
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 11px;
            background: white;
            padding: 10px;
            border-radius: 5px;
        }

        .hex-dump {
            word-break: break-all;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¦ ç–¯ç‹‚åŠ¨ç‰©å›­ WebSocket æµ‹è¯•å·¥å…· ğŸ˜</h1>
            <div class="status-bar">
                <div class="status">
                    <div class="status-indicator" id="statusIndicator"></div>
                    <span id="statusText">æœªè¿æ¥</span>
                </div>
                <div id="connectionInfo">
                    <span id="connectionTime"></span>
                    <span id="roomInfo" style="margin-left: 20px;"></span>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="control-panel">
                <!-- è¿æ¥æ§åˆ¶ -->
                <div class="control-section">
                    <h3>ğŸ”Œ è¿æ¥è®¾ç½®</h3>
                    <div class="input-group">
                        <label>WebSocket URL</label>
                        <input type="text" id="wsUrl" value="ws://localhost:8080/ws/game?game=animal" placeholder="ws://localhost:8080/ws/game?game=animal">
                    </div>
                    <button id="connectBtn" class="btn btn-primary" onclick="connect()">è¿æ¥æœåŠ¡å™¨</button>
                    <button id="disconnectBtn" class="btn btn-danger" onclick="disconnect()" disabled>æ–­å¼€è¿æ¥</button>
                </div>

                <!-- æˆ¿é—´æ§åˆ¶ -->
                <div class="control-section">
                    <h3>ğŸ  æˆ¿é—´ç®¡ç†</h3>
                    <div class="input-group">
                        <label>åœºæ¬¡ç±»å‹</label>
                        <select id="zooType">
                            <option value="1">å¹³æ°‘åœº</option>
                            <option value="2">å°èµ„åœº</option>
                            <option value="3">å¯Œè±ªåœº</option>
                            <option value="4">é»„é‡‘åœº</option>
                            <option value="5">é’»çŸ³åœº</option>
                            <option value="6">å•äººåœº</option>
                            <option value="7">ä½“éªŒåœº</option>
                        </select>
                    </div>
                    <button class="btn btn-success" onclick="sendEnterRoom()">è¿›å…¥æˆ¿é—´ (1801)</button>
                    <button class="btn btn-warning" onclick="sendLeaveRoom()">ç¦»å¼€æˆ¿é—´ (1802)</button>
                    <button class="btn btn-info" onclick="sendGetZooInfo()">è·å–åœºæ¬¡ä¿¡æ¯ (1807)</button>
                </div>

                <!-- å°„å‡»æ§åˆ¶ -->
                <div class="control-section">
                    <h3>ğŸ¯ å°„å‡»æ§åˆ¶</h3>
                    <div class="input-group">
                        <label>ä¸‹æ³¨é‡‘é¢</label>
                        <select id="betAmount">
                            <option value="10">10</option>
                            <option value="50">50</option>
                            <option value="100" selected>100</option>
                            <option value="200">200</option>
                            <option value="500">500</option>
                            <option value="1000">1000</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>ç›®æ ‡åŠ¨ç‰©ID</label>
                        <input type="number" id="targetAnimalId" value="1" min="1">
                    </div>
                    <button class="btn btn-danger" onclick="sendFireBullet()">å‘å°„å­å¼¹ (1815)</button>
                    <button class="btn btn-warning" onclick="sendBet()">ä¸‹æ³¨æ‰“å‡» (1803)</button>
                </div>

                <!-- æŠ€èƒ½æ§åˆ¶ -->
                <div class="control-section">
                    <h3>âš¡ æŠ€èƒ½ç³»ç»Ÿ</h3>
                    <div class="skill-container">
                        <div class="skill-item" onclick="useSkill(1)">
                            â„ï¸ å†°å†»
                            <div class="skill-count" id="skill_1">0</div>
                        </div>
                        <div class="skill-item" onclick="useSkill(2)">
                            ğŸ¯ é”å®š
                            <div class="skill-count" id="skill_2">0</div>
                        </div>
                        <div class="skill-item" onclick="useSkill(3)">
                            âœ¨ å€ç‡
                            <div class="skill-count" id="skill_3">0</div>
                        </div>
                    </div>
                    <div class="quick-actions" style="margin-top: 10px;">
                        <button class="btn quick-btn btn-info" onclick="sendBuySkill(1)">è´­ä¹°å†°å†»</button>
                        <button class="btn quick-btn btn-info" onclick="sendBuySkill(2)">è´­ä¹°é”å®š</button>
                        <button class="btn quick-btn btn-info" onclick="sendBuySkill(3)">è´­ä¹°å€ç‡</button>
                        <button class="btn quick-btn btn-info" onclick="sendGetToolsPrice()">æŸ¥è¯¢ä»·æ ¼</button>
                    </div>
                </div>

                <!-- æ•°æ®æŸ¥è¯¢ -->
                <div class="control-section">
                    <h3>ğŸ“Š æ•°æ®æŸ¥è¯¢</h3>
                    <button class="btn btn-info" onclick="sendGetRecord()">æ¸¸æˆè®°å½• (1804)</button>
                    <button class="btn btn-info" onclick="sendGetReward()">å¤§å¥–è®°å½• (1805)</button>
                    <button class="btn btn-info" onclick="sendGetCJLog()">å½©é‡‘è®°å½• (1812)</button>
                </div>

                <!-- å¿«é€Ÿæµ‹è¯• -->
                <div class="control-section">
                    <h3>ğŸš€ å¿«é€Ÿæµ‹è¯•</h3>
                    <div class="quick-actions">
                        <button class="btn quick-btn btn-success" onclick="quickTest('enter')">è¿›æˆ¿æµ‹è¯•</button>
                        <button class="btn quick-btn btn-success" onclick="quickTest('shoot')">å°„å‡»æµ‹è¯•</button>
                        <button class="btn quick-btn btn-success" onclick="quickTest('skill')">æŠ€èƒ½æµ‹è¯•</button>
                        <button class="btn quick-btn btn-success" onclick="quickTest('full')">å®Œæ•´æµç¨‹</button>
                    </div>
                </div>

                <!-- æ¸¸æˆçŠ¶æ€ -->
                <div class="game-state">
                    <h4>ğŸ® æ¸¸æˆçŠ¶æ€</h4>
                    <div class="state-grid">
                        <div class="state-item">
                            <span class="state-label">é‡‘å¸:</span>
                            <span class="state-value" id="playerBalance">0</span>
                        </div>
                        <div class="state-item">
                            <span class="state-label">ä½“éªŒå¸:</span>
                            <span class="state-value" id="freeGold">0</span>
                        </div>
                        <div class="state-item">
                            <span class="state-label">ç´¯è®¡èµ¢å–:</span>
                            <span class="state-value" id="totalWin">0</span>
                        </div>
                        <div class="state-item">
                            <span class="state-label">å½©é‡‘æ± :</span>
                            <span class="state-value" id="jackpot">0</span>
                        </div>
                    </div>
                    <div class="animal-list" id="animalList">
                        <div style="text-align: center; color: #999;">æš‚æ— åŠ¨ç‰©</div>
                    </div>
                </div>

                <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                <div class="stats-container">
                    <div class="stat-box">
                        <div class="stat-value" id="sentCount">0</div>
                        <div class="stat-label">å‘é€</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="receivedCount">0</div>
                        <div class="stat-label">æ¥æ”¶</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="pushCount">0</div>
                        <div class="stat-label">æ¨é€</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="errorCount">0</div>
                        <div class="stat-label">é”™è¯¯</div>
                    </div>
                </div>
            </div>

            <div class="message-panel">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('all')">å…¨éƒ¨æ¶ˆæ¯</button>
                    <button class="tab" onclick="switchTab('sent')">å‘é€æ¶ˆæ¯</button>
                    <button class="tab" onclick="switchTab('received')">æ¥æ”¶å“åº”</button>
                    <button class="tab" onclick="switchTab('push')">æ¨é€æ¶ˆæ¯</button>
                    <button class="tab" onclick="switchTab('debug')">è°ƒè¯•ä¿¡æ¯</button>
                </div>

                <div class="tab-content active" id="tab-all"></div>
                <div class="tab-content" id="tab-sent"></div>
                <div class="tab-content" id="tab-received"></div>
                <div class="tab-content" id="tab-push"></div>
                <div class="tab-content" id="tab-debug"></div>
            </div>
        </div>
    </div>

    <script>
        // WebSocketè¿æ¥
        let ws = null;
        let connectionStartTime = null;

        // ç»Ÿè®¡è®¡æ•°
        let sentCount = 0;
        let receivedCount = 0;
        let pushCount = 0;
        let errorCount = 0;

        // æ¸¸æˆçŠ¶æ€
        let gameState = {
            roomType: 0,
            animals: new Map(),
            players: new Map(),
            skills: new Map(),
            balance: 0,
            freeGold: 0,
            totalWin: 0,
            jackpot: 0,
            betValues: []
        };

        // æ¶ˆæ¯ç±»å‹æ˜ å°„
        const MESSAGE_TYPES = {
            // å®¢æˆ·ç«¯è¯·æ±‚
            1801: 'è¿›å…¥æˆ¿é—´',
            1802: 'ç¦»å¼€æˆ¿é—´',
            1803: 'ä¸‹æ³¨æ‰“å‡»',
            1804: 'æŸ¥çœ‹è®°å½•',
            1805: 'æŸ¥çœ‹å¤§å¥–',
            1806: 'ä½¿ç”¨æŠ€èƒ½',
            1807: 'è·å–åœºæ¬¡',
            1808: 'è´­ä¹°é“å…·',
            1809: 'è·å–ä»·æ ¼',
            1812: 'å½©é‡‘è®°å½•',
            1815: 'å‘å°„å­å¼¹',

            // æ´»åŠ¨åœº
            1871: 'è¿›å…¥æ´»åŠ¨',
            1872: 'æ‰“æ´»åŠ¨åŠ¨ç‰©',
            1873: 'è·å–æ’è¡Œ',
            1879: 'è§‚æˆ˜è§†è§’',

            // æœåŠ¡å™¨æ¨é€
            1810: 'æ¨é€å½©é‡‘',
            1811: 'å½©é‡‘ä¸­å¥–',
            1813: 'ä¸€å‡»å¿…æ€',
            1814: 'æ¸…é™¤å¿…æ€',
            1882: 'ä½¿ç”¨æŠ€èƒ½',
            1883: 'åŠ¨ç‰©é¢„å‘Š',
            1884: 'åŠ¨ç‰©æ­»äº¡',
            1885: 'ç©å®¶ç¦»å¼€',
            1886: 'ç©å®¶è¿›å…¥',
            1887: 'åŠ¨ç‰©è¿›å…¥',
            1888: 'åŠ¨ç‰©ç¦»å¼€',
            1889: 'æ´»åŠ¨å¹¿æ’­',
            1899: 'æ‰“å‡»åŠ¨ç‰©',

            // æ´»åŠ¨æ¨é€
            1874: 'æ´»åŠ¨åŠ¨ç‰©ç¦»å¼€',
            1875: 'æ´»åŠ¨ç»“æŸ',
            1876: 'æ´»åŠ¨åŠ¨ç‰©è¿›å…¥',
            1877: 'æ´»åŠ¨åŠ¨ç‰©æ­»äº¡',
            1878: 'æ´»åŠ¨çŠ¶æ€',
            1880: 'æ´»åŠ¨æ’è¡Œ',
            1881: 'æ´»åŠ¨ç‚¹å‡»'
        };

        // åŠ¨ç‰©ç±»å‹æ˜ å°„
        const ANIMAL_TYPES = {
            0: 'é‡‘è±†',
            1: 'ä¹Œé¾Ÿ',
            2: 'å…¬é¸¡',
            3: 'æ–—ç‰›çŠ¬',
            4: 'é‡‘ä¸çŒ´',
            5: 'çŸ®é©¬',
            6: 'å¥¶ç‰›',
            7: 'ç†ŠçŒ«',
            8: 'æ²³é©¬',
            9: 'ç‹®å­',
            10: 'å¤§è±¡',
            11: 'çš®å¡ä¸˜',
            12: 'ç‚¸å¼¹äºº',
            13: 'è€è™',
            14: 'ç¾Šé©¼',
            15: 'ç†Š',
            16: 'å…”å­',
            17: 'é©´',
            18: 'è±¹å­',
            19: 'çŒª',
            20: 'æ²³é©¬'
        };

        // æŠ€èƒ½ç±»å‹æ˜ å°„
        const SKILL_TYPES = {
            1: 'å†°å†»æŠ€èƒ½',
            2: 'é”å®šç›®æ ‡',
            3: 'å€ç‡æå‡'
        };

        // åœºæ¬¡ç±»å‹æ˜ å°„
        const ZOO_TYPES = {
            1: 'å¹³æ°‘åœº',
            2: 'å°èµ„åœº',
            3: 'å¯Œè±ªåœº',
            4: 'é»„é‡‘åœº',
            5: 'é’»çŸ³åœº',
            6: 'å•äººåœº',
            7: 'ä½“éªŒåœº'
        };

        // Protobufç¼–è§£ç 
        class ProtobufCodec {
            static encodeVarint(value) {
                const bytes = [];
                while (value > 0x7f) {
                    bytes.push((value & 0x7f) | 0x80);
                    value >>>= 7;
                }
                bytes.push(value & 0x7f);
                return bytes;
            }

            static decodeVarint(bytes, offset = 0) {
                let value = 0;
                let shift = 0;
                while (offset < bytes.length) {
                    const byte = bytes[offset++];
                    value |= (byte & 0x7f) << shift;
                    if ((byte & 0x80) === 0) {
                        return { value, offset };
                    }
                    shift += 7;
                }
                throw new Error('Varint too long');
            }

            static encodeMessage(msgId, fields = {}) {
                const data = [];

                // ç¼–ç å­—æ®µ
                for (const [fieldNum, value] of Object.entries(fields)) {
                    const tag = (parseInt(fieldNum) << 3) | 0; // VARINTç±»å‹
                    data.push(...this.encodeVarint(tag));

                    if (typeof value === 'number') {
                        data.push(...this.encodeVarint(value));
                    } else if (typeof value === 'string') {
                        const strBytes = new TextEncoder().encode(value);
                        const lenTag = (parseInt(fieldNum) << 3) | 2; // LENGTH_DELIMITED
                        data.push(lenTag);
                        data.push(...this.encodeVarint(strBytes.length));
                        data.push(...strBytes);
                    } else if (value instanceof Uint8Array) {
                        const lenTag = (parseInt(fieldNum) << 3) | 2;
                        data.push(lenTag);
                        data.push(...this.encodeVarint(value.length));
                        data.push(...value);
                    }
                }

                // æ„å»ºå®Œæ•´æ¶ˆæ¯
                const protoData = new Uint8Array(data);
                const totalLength = 2 + protoData.length;
                const buffer = new ArrayBuffer(4 + totalLength);
                const view = new DataView(buffer);
                const bytes = new Uint8Array(buffer);

                view.setUint32(0, totalLength, false); // é•¿åº¦
                view.setUint16(4, msgId, false); // æ¶ˆæ¯ID
                bytes.set(protoData, 6);

                return buffer;
            }

            static decodeMessage(buffer) {
                const bytes = new Uint8Array(buffer);
                const view = new DataView(buffer);

                if (bytes.length < 6) {
                    return { msgId: 0, fields: {}, error: 'æ¶ˆæ¯å¤ªçŸ­' };
                }

                const length = view.getUint32(0, false);
                const msgId = view.getUint16(4, false);
                const dataBytes = bytes.slice(6);

                // è§£æå­—æ®µ
                const fields = {};
                let offset = 0;

                while (offset < dataBytes.length) {
                    const tagResult = this.decodeVarint(dataBytes, offset);
                    if (!tagResult) break;

                    const tag = tagResult.value;
                    offset = tagResult.offset;

                    const fieldNum = tag >>> 3;
                    const wireType = tag & 7;

                    if (wireType === 0) { // VARINT
                        const result = this.decodeVarint(dataBytes, offset);
                        fields[fieldNum] = result.value;
                        offset = result.offset;
                    } else if (wireType === 2) { // LENGTH_DELIMITED
                        const lenResult = this.decodeVarint(dataBytes, offset);
                        const len = lenResult.value;
                        offset = lenResult.offset;

                        const data = dataBytes.slice(offset, offset + len);
                        fields[fieldNum] = data;
                        offset += len;
                    }
                }

                return { msgId, fields, length };
            }
        }

        // è¿æ¥WebSocket
        function connect() {
            const url = document.getElementById('wsUrl').value;

            if (!url) {
                showError('è¯·è¾“å…¥WebSocket URL');
                return;
            }

            try {
                ws = new WebSocket(url);
                ws.binaryType = 'arraybuffer';

                ws.onopen = () => {
                    connectionStartTime = Date.now();
                    updateStatus(true);
                    addMessage('all', 'âœ… è¿æ¥æˆåŠŸ', 'received');
                };

                ws.onmessage = (event) => {
                    if (event.data instanceof ArrayBuffer) {
                        handleMessage(event.data);
                    }
                };

                ws.onerror = (event) => {
                    errorCount++;
                    updateStats();
                    addMessage('all', 'âŒ è¿æ¥é”™è¯¯', 'error');
                };

                ws.onclose = (event) => {
                    connectionStartTime = null;
                    updateStatus(false);
                    addMessage('all', `âš ï¸ è¿æ¥å…³é—­ (${event.code})`, 'error');
                };

            } catch (error) {
                showError('è¿æ¥å¤±è´¥: ' + error.message);
            }
        }

        // æ–­å¼€è¿æ¥
        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        // å‘é€æ¶ˆæ¯
        function sendMessage(msgId, fields = {}) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                showError('WebSocketæœªè¿æ¥');
                return;
            }

            const buffer = ProtobufCodec.encodeMessage(msgId, fields);
            ws.send(buffer);

            sentCount++;
            updateStats();

            const msgName = MESSAGE_TYPES[msgId] || `æ¶ˆæ¯${msgId}`;
            addMessage('sent', `ğŸ“¤ [${msgId}] ${msgName}`, 'sent', fields);
        }

        // å¤„ç†æ¥æ”¶çš„æ¶ˆæ¯
        function handleMessage(buffer) {
            const decoded = ProtobufCodec.decodeMessage(buffer);
            const msgName = MESSAGE_TYPES[decoded.msgId] || `æ¶ˆæ¯${decoded.msgId}`;

            // åˆ¤æ–­æ˜¯æ¨é€è¿˜æ˜¯å“åº”
            const isPush = decoded.msgId >= 1810 && decoded.msgId !== 1812;

            if (isPush) {
                pushCount++;
                addMessage('push', `ğŸ“¥ [${decoded.msgId}] ${msgName}`, 'push', decoded.fields);
                handlePushMessage(decoded.msgId, decoded.fields);
            } else {
                receivedCount++;
                addMessage('received', `ğŸ“¥ [${decoded.msgId}] ${msgName}`, 'received', decoded.fields);
                handleResponse(decoded.msgId, decoded.fields);
            }

            updateStats();
        }

        // å¤„ç†å“åº”æ¶ˆæ¯
        function handleResponse(msgId, fields) {
            switch(msgId) {
                case 1801: // è¿›å…¥æˆ¿é—´å“åº”
                    handleEnterRoomResponse(fields);
                    break;
                case 1802: // ç¦»å¼€æˆ¿é—´å“åº”
                    handleLeaveRoomResponse(fields);
                    break;
                case 1803: // ä¸‹æ³¨å“åº”
                    handleBetResponse(fields);
                    break;
                case 1806: // ä½¿ç”¨æŠ€èƒ½å“åº”
                    handleUseSkillResponse(fields);
                    break;
                case 1815: // å‘å°„å­å¼¹å“åº”
                    handleFireBulletResponse(fields);
                    break;
            }
        }

        // å¤„ç†æ¨é€æ¶ˆæ¯
        function handlePushMessage(msgId, fields) {
            switch(msgId) {
                case 1887: // åŠ¨ç‰©è¿›å…¥
                    handleAnimalEnter(fields);
                    break;
                case 1888: // åŠ¨ç‰©ç¦»å¼€
                    handleAnimalLeave(fields);
                    break;
                case 1884: // åŠ¨ç‰©æ­»äº¡
                    handleAnimalDie(fields);
                    break;
                case 1810: // æ¨é€å½©é‡‘
                    handleJackpot(fields);
                    break;
            }
        }

        // å¤„ç†è¿›å…¥æˆ¿é—´å“åº”
        function handleEnterRoomResponse(fields) {
            // æ›´æ–°æ¸¸æˆçŠ¶æ€
            if (fields[1]) { // bet_val
                gameState.betValues = Array.isArray(fields[1]) ? fields[1] : [fields[1]];
            }
            if (fields[9]) { // free_gold
                gameState.freeGold = fields[9];
                document.getElementById('freeGold').textContent = fields[9];
            }
            if (fields[10]) { // å½©é‡‘
                const cj = new TextDecoder().decode(fields[10]);
                gameState.jackpot = cj;
                document.getElementById('jackpot').textContent = cj;
            }

            updateRoomInfo();
        }

        // å¤„ç†ç¦»å¼€æˆ¿é—´å“åº”
        function handleLeaveRoomResponse(fields) {
            if (fields[1]) { // total_win
                gameState.totalWin = fields[1];
                document.getElementById('totalWin').textContent = fields[1];
            }

            // æ¸…ç©ºåŠ¨ç‰©åˆ—è¡¨
            gameState.animals.clear();
            updateAnimalList();
        }

        // å¤„ç†ä¸‹æ³¨å“åº”
        function handleBetResponse(fields) {
            if (fields[1]) { // balance
                gameState.balance = fields[1];
                document.getElementById('playerBalance').textContent = fields[1];
            }
            if (fields[6]) { // total_win
                gameState.totalWin = fields[6];
                document.getElementById('totalWin').textContent = fields[6];
            }
        }

        // å¤„ç†å‘å°„å­å¼¹å“åº”
        function handleFireBulletResponse(fields) {
            if (fields[2]) { // balance
                gameState.balance = fields[2];
                document.getElementById('playerBalance').textContent = fields[2];
            }
        }

        // å¤„ç†ä½¿ç”¨æŠ€èƒ½å“åº”
        function handleUseSkillResponse(fields) {
            // æ›´æ–°æŠ€èƒ½æ˜¾ç¤º
            updateSkillDisplay();
        }

        // å¤„ç†åŠ¨ç‰©è¿›å…¥
        function handleAnimalEnter(fields) {
            if (fields[1]) { // animals
                // è§£æåŠ¨ç‰©æ•°æ®
                updateAnimalList();
            }
        }

        // å¤„ç†åŠ¨ç‰©ç¦»å¼€
        function handleAnimalLeave(fields) {
            if (fields[1]) { // id
                gameState.animals.delete(fields[1]);
                updateAnimalList();
            }
        }

        // å¤„ç†åŠ¨ç‰©æ­»äº¡
        function handleAnimalDie(fields) {
            if (fields[3]) { // ids
                // å¤„ç†æ­»äº¡çš„åŠ¨ç‰©åˆ—è¡¨
                updateAnimalList();
            }
        }

        // å¤„ç†å½©é‡‘æ¨é€
        function handleJackpot(fields) {
            if (fields[1]) { // bonus
                const bonus = new TextDecoder().decode(fields[1]);
                gameState.jackpot = bonus;
                document.getElementById('jackpot').textContent = bonus;
            }
        }

        // å‘é€è¿›å…¥æˆ¿é—´
        function sendEnterRoom() {
            const zooType = parseInt(document.getElementById('zooType').value);
            sendMessage(1801, { 1: zooType });
        }

        // å‘é€ç¦»å¼€æˆ¿é—´
        function sendLeaveRoom() {
            sendMessage(1802, {});
        }

        // å‘é€å‘å°„å­å¼¹
        function sendFireBullet() {
            const betVal = parseInt(document.getElementById('betAmount').value);
            sendMessage(1815, { 1: betVal });
        }

        // å‘é€ä¸‹æ³¨
        function sendBet() {
            const targetId = parseInt(document.getElementById('targetAnimalId').value);
            sendMessage(1803, { 1: targetId });
        }

        // ä½¿ç”¨æŠ€èƒ½
        function useSkill(skillType) {
            sendMessage(1806, { 1: skillType });
        }

        // å‘é€è´­ä¹°æŠ€èƒ½
        function sendBuySkill(skillType) {
            sendMessage(1808, { 1: skillType });
        }

        // å‘é€è·å–åœºæ¬¡ä¿¡æ¯
        function sendGetZooInfo() {
            sendMessage(1807, {});
        }

        // å‘é€è·å–è®°å½•
        function sendGetRecord() {
            sendMessage(1804, { 1: 1, 2: 10 });
        }

        // å‘é€è·å–å¤§å¥–
        function sendGetReward() {
            sendMessage(1805, {});
        }

        // å‘é€è·å–å½©é‡‘è®°å½•
        function sendGetCJLog() {
            sendMessage(1812, {});
        }

        // å‘é€è·å–é“å…·ä»·æ ¼
        function sendGetToolsPrice() {
            sendMessage(1809, {});
        }

        // å¿«é€Ÿæµ‹è¯•
        function quickTest(type) {
            switch(type) {
                case 'enter':
                    sendEnterRoom();
                    break;
                case 'shoot':
                    sendEnterRoom();
                    setTimeout(() => sendFireBullet(), 500);
                    setTimeout(() => sendBet(), 1000);
                    break;
                case 'skill':
                    sendEnterRoom();
                    setTimeout(() => sendBuySkill(1), 500);
                    setTimeout(() => useSkill(1), 1000);
                    break;
                case 'full':
                    sendEnterRoom();
                    setTimeout(() => sendFireBullet(), 1000);
                    setTimeout(() => sendBet(), 2000);
                    setTimeout(() => sendBuySkill(1), 3000);
                    setTimeout(() => useSkill(1), 4000);
                    setTimeout(() => sendLeaveRoom(), 10000);
                    break;
            }
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°ç•Œé¢
        function addMessage(tab, title, type, data = {}) {
            const time = new Date().toLocaleTimeString();
            const message = document.createElement('div');
            message.className = `message ${type}`;

            let content = `
                <div class="message-header">
                    <span class="message-type">${title}</span>
                    <span class="message-time">${time}</span>
                </div>
            `;

            if (Object.keys(data).length > 0) {
                content += '<div class="proto-fields">';
                for (const [key, value] of Object.entries(data)) {
                    content += `
                        <div class="proto-field">
                            <span class="field-name">field_${key}</span>:
                            <span class="field-value">${formatFieldValue(value)}</span>
                        </div>
                    `;
                }
                content += '</div>';
            }

            message.innerHTML = content;

            // æ·»åŠ åˆ°æŒ‡å®šæ ‡ç­¾é¡µ
            if (tab === 'all' || tab === type) {
                document.getElementById(`tab-${tab}`).insertBefore(
                    message,
                    document.getElementById(`tab-${tab}`).firstChild
                );
            }

            // æ€»æ˜¯æ·»åŠ åˆ°å…¨éƒ¨æ ‡ç­¾é¡µ
            if (tab !== 'all') {
                const allMessage = message.cloneNode(true);
                document.getElementById('tab-all').insertBefore(
                    allMessage,
                    document.getElementById('tab-all').firstChild
                );
            }
        }

        // æ ¼å¼åŒ–å­—æ®µå€¼
        function formatFieldValue(value) {
            if (value instanceof Uint8Array) {
                // å°è¯•ä½œä¸ºå­—ç¬¦ä¸²è§£ç 
                try {
                    return new TextDecoder().decode(value);
                } catch {
                    return `[${value.length} bytes]`;
                }
            } else if (Array.isArray(value)) {
                return `[${value.join(', ')}]`;
            } else if (typeof value === 'object') {
                return JSON.stringify(value);
            }
            return value;
        }

        // æ›´æ–°çŠ¶æ€æ 
        function updateStatus(connected) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');

            if (connected) {
                indicator.classList.add('connected');
                text.textContent = 'å·²è¿æ¥';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            } else {
                indicator.classList.remove('connected');
                text.textContent = 'æœªè¿æ¥';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            }
        }

        // æ›´æ–°ç»Ÿè®¡
        function updateStats() {
            document.getElementById('sentCount').textContent = sentCount;
            document.getElementById('receivedCount').textContent = receivedCount;
            document.getElementById('pushCount').textContent = pushCount;
            document.getElementById('errorCount').textContent = errorCount;
        }

        // æ›´æ–°æˆ¿é—´ä¿¡æ¯
        function updateRoomInfo() {
            const roomType = ZOO_TYPES[gameState.roomType] || 'æœªçŸ¥';
            document.getElementById('roomInfo').textContent = `æˆ¿é—´: ${roomType}`;
        }

        // æ›´æ–°åŠ¨ç‰©åˆ—è¡¨
        function updateAnimalList() {
            const list = document.getElementById('animalList');
            if (gameState.animals.size === 0) {
                list.innerHTML = '<div style="text-align: center; color: #999;">æš‚æ— åŠ¨ç‰©</div>';
            } else {
                list.innerHTML = '';
                gameState.animals.forEach((animal, id) => {
                    const item = document.createElement('div');
                    item.className = 'animal-item';
                    item.innerHTML = `
                        <span class="animal-name">${ANIMAL_TYPES[animal.type] || 'æœªçŸ¥'}</span>
                        <span class="animal-info">ID: ${id} | çº¿è·¯: ${animal.line}</span>
                    `;
                    list.appendChild(item);
                });
            }
        }

        // æ›´æ–°æŠ€èƒ½æ˜¾ç¤º
        function updateSkillDisplay() {
            gameState.skills.forEach((skill, type) => {
                const element = document.getElementById(`skill_${type}`);
                if (element) {
                    element.textContent = skill.count || 0;
                }
            });
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            // åˆ‡æ¢æ ‡ç­¾æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // åˆ‡æ¢å†…å®¹æ˜¾ç¤º
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            alert(message);
        }

        // æ›´æ–°è¿æ¥æ—¶é—´
        setInterval(() => {
            if (connectionStartTime) {
                const elapsed = Math.floor((Date.now() - connectionStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('connectionTime').textContent =
                    `è¿æ¥æ—¶é•¿: ${minutes}åˆ†${seconds}ç§’`;
            } else {
                document.getElementById('connectionTime').textContent = '';
            }
        }, 1000);
    </script>
</body>
</html>