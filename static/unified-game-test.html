<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ç»Ÿä¸€æ¸¸æˆæµ‹è¯•å·¥å…·</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 300px 1fr 400px;
            gap: 20px;
        }

        .panel {
            background: #2a2a2a;
            border: 1px solid #00ff00;
            border-radius: 5px;
            padding: 15px;
        }

        h1, h2, h3 {
            color: #00ff00;
            text-shadow: 0 0 10px #00ff00;
            margin: 0 0 15px 0;
        }

        .control-group {
            margin-bottom: 15px;
            padding: 10px;
            background: #1e1e1e;
            border-radius: 3px;
        }

        label {
            display: inline-block;
            width: 120px;
            color: #00ffff;
        }

        input, select, button {
            background: #1e1e1e;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 5px 10px;
            font-family: inherit;
            width: calc(100% - 130px);
            margin-top: 5px;
        }

        button {
            cursor: pointer;
            width: 100%;
            margin: 5px 0;
            transition: all 0.3s;
        }

        button:hover {
            background: #00ff00;
            color: #1e1e1e;
            box-shadow: 0 0 10px #00ff00;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #output {
            height: 500px;
            overflow-y: auto;
            background: #1e1e1e;
            padding: 10px;
            font-size: 12px;
            border-radius: 3px;
        }

        .log-entry {
            margin: 2px 0;
            padding: 2px 5px;
        }

        .log-send { color: #00ffff; }
        .log-receive { color: #ffff00; }
        .log-error { color: #ff0000; }
        .log-info { color: #00ff00; }
        .log-heartbeat { color: #ff00ff; }
        .log-jackpot { color: #ffd700; text-shadow: 0 0 5px #ffd700; }

        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 3px;
            margin-right: 10px;
        }

        .status.connected {
            background: #00ff00;
            color: #1e1e1e;
        }

        .status.disconnected {
            background: #ff0000;
            color: white;
        }

        .quick-action {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
        }

        .jackpot-panel {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #1e1e1e;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 0 20px #ffd700;
        }

        .jackpot-amount {
            font-size: 32px;
            font-weight: bold;
            margin: 10px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .heartbeat-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background: #00ff00;
            border-radius: 50%;
            margin-left: 10px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }

        .message-templates {
            max-height: 300px;
            overflow-y: auto;
        }

        .template-button {
            font-size: 11px;
            padding: 3px 5px;
            margin: 2px;
        }
    </style>
</head>
<body>
    <h1>ğŸ® ç»Ÿä¸€æ¸¸æˆæµ‹è¯•å·¥å…· - Protobufç‰ˆæœ¬</h1>

    <div class="container">
        <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
        <div class="panel">
            <h3>è¿æ¥æ§åˆ¶</h3>

            <div class="control-group">
                <label>æœåŠ¡å™¨åœ°å€:</label>
                <input type="text" id="serverUrl" value="ws://localhost:8080/ws/game">
            </div>

            <div class="control-group">
                <label>æ¸¸æˆç±»å‹:</label>
                <select id="gameType">
                    <option value="slot">è€è™æœº (Slot)</option>
                    <option value="animal">åŠ¨ç‰©æ¸¸æˆ (Animal)</option>
                </select>
            </div>

            <button id="connectBtn" onclick="connect()">è¿æ¥æœåŠ¡å™¨</button>
            <button id="disconnectBtn" onclick="disconnect()" disabled>æ–­å¼€è¿æ¥</button>

            <div style="margin-top: 15px;">
                <span class="status disconnected" id="status">æœªè¿æ¥</span>
                <span id="heartbeatStatus"></span>
            </div>

            <h3 style="margin-top: 20px;">å¿«é€Ÿæ“ä½œ</h3>

            <div id="slotActions" class="quick-action">
                <button onclick="sendMessage(1901, {})">å¼€å§‹æ¸¸æˆ</button>
                <button onclick="sendMessage(1902, {bet: 100})">è½¬åŠ¨(100)</button>
                <button onclick="sendMessage(1904, {})">ç»“ç®—</button>
                <button onclick="sendMessage(1905, {})">å†å²è®°å½•</button>
            </div>

            <div id="animalActions" class="quick-action" style="display: none;">
                <button onclick="sendMessage(1801, {type: 7})">è¿›å…¥Freeæˆ¿é—´</button>
                <button onclick="sendMessage(1802, {})">é€€å‡ºæˆ¿é—´</button>
                <button onclick="sendMessage(1803, {})">å¼€ç«å°„å‡»</button>
                <button onclick="sendMessage(1815, {bulletId: 1, x: 500, y: 300, angle: 45})">å‘å°„å­å¼¹</button>
                <button onclick="sendMessage(1812, {})">å½©é‡‘å†å²</button>
            </div>

            <h3 style="margin-top: 20px;">é…ç½®æ“ä½œ</h3>
            <button onclick="sendMessage(2001, {})">è·å–é…ç½®</button>
            <button onclick="sendMessage(2099, {})">å‘é€å¿ƒè·³</button>
            <button onclick="sendMessage(2002, {error: 'test error'})">æŠ¥å‘Šé”™è¯¯</button>
        </div>

        <!-- ä¸­é—´æ—¥å¿—è¾“å‡º -->
        <div class="panel">
            <h3>æ¶ˆæ¯æ—¥å¿—</h3>
            <button onclick="clearLog()" style="width: auto; padding: 5px 15px; margin-bottom: 10px;">æ¸…ç©ºæ—¥å¿—</button>
            <div id="output"></div>
        </div>

        <!-- å³ä¾§çŠ¶æ€é¢æ¿ -->
        <div class="panel">
            <!-- å½©é‡‘æ˜¾ç¤º -->
            <div class="jackpot-panel" id="jackpotPanel" style="display: none;">
                <h3>ğŸ’° å½©é‡‘æ± </h3>
                <div class="jackpot-amount" id="jackpotAmount">Â¥0</div>
                <div style="font-size: 12px;">æ¯30ç§’è‡ªåŠ¨æ›´æ–°</div>
            </div>

            <h3>æ¸¸æˆçŠ¶æ€</h3>
            <div class="control-group">
                <div>ç©å®¶ID: <span id="playerId">-</span></div>
                <div>ä½™é¢: <span id="balance">-</span></div>
                <div>å¿ƒè·³: <span id="heartbeatCount">0</span> <span class="heartbeat-indicator" id="heartbeatIndicator"></span></div>
                <div>è¿æ¥æ—¶é•¿: <span id="connectionTime">0s</span></div>
            </div>

            <h3 style="margin-top: 20px;">è‡ªå®šä¹‰æ¶ˆæ¯</h3>
            <div class="control-group">
                <label>æ¶ˆæ¯ID:</label>
                <input type="number" id="customMsgId" placeholder="å¦‚: 1901">
            </div>

            <div class="control-group">
                <label>æ¶ˆæ¯æ•°æ®:</label>
                <textarea id="customData" style="width: 100%; height: 100px; font-family: inherit; background: #1e1e1e; color: #00ff00; border: 1px solid #00ff00;" placeholder='{"key": "value"}'>{}</textarea>
            </div>

            <button onclick="sendCustomMessage()">å‘é€è‡ªå®šä¹‰æ¶ˆæ¯</button>

            <h3 style="margin-top: 20px;">æ¶ˆæ¯æ¨¡æ¿</h3>
            <div class="message-templates">
                <button class="template-button" onclick="setTemplate(1901, '{}')">1901-å¼€å§‹æ¸¸æˆ</button>
                <button class="template-button" onclick="setTemplate(1902, '{\"bet\": 100, \"lines\": 25}')">1902-è½¬åŠ¨</button>
                <button class="template-button" onclick="setTemplate(1903, '{\"bet\": 100, \"count\": 10}')">1903-æ‰¹é‡è½¬åŠ¨</button>
                <button class="template-button" onclick="setTemplate(1801, '{\"type\": 7}')">1801-è¿›å…¥Freeæˆ¿é—´</button>
                <button class="template-button" onclick="setTemplate(1803, '{}')">1803-å¼€ç«</button>
                <button class="template-button" onclick="setTemplate(2099, '{}')">2099-å¿ƒè·³</button>
                <button class="template-button" onclick="setTemplate(2001, '{}')">2001-è·å–é…ç½®</button>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let heartbeatInterval = null;
        let heartbeatCount = 0;
        let connectionStartTime = null;
        let connectionTimer = null;
        let jackpotUpdateInterval = null;
        let currentJackpot = 0;

        // Protobuf wire types
        const WIRE_TYPES = {
            VARINT: 0,
            FIXED64: 1,
            LENGTH_DELIMITED: 2,
            FIXED32: 5
        };

        // åŠ¨ç‰©æ¸¸æˆå­—æ®µåç§°æ˜ å°„
        const FIELD_NAMES = {
            1801: { // m_1801_toc - è¿›å…¥æˆ¿é—´å“åº”
                1: 'bet_values (ä¸‹æ³¨æ¡£ä½)',
                2: 'odds (èµ”ç‡ä¿¡æ¯)',
                3: 'animals (åŠ¨ç‰©åˆ—è¡¨)'
            },
            1815: { // m_1815_toc - å°„å‡»å“åº”
                1: 'bullet_id (å­å¼¹ID)',
                2: 'hit_animals (å‡»ä¸­åŠ¨ç‰©)',
                3: 'bonus (å¥–åŠ±)'
            },
            2001: { // m_2001_toc - é…ç½®å“åº”
                1: 'role_id (ç©å®¶ID)',
                2: 'balance (ä½™é¢)',
                3: 'config (é…ç½®ä¿¡æ¯)'
            },
            2099: { // å¿ƒè·³å“åº”
                1: 'timestamp (æ—¶é—´æˆ³)'
            }
        };

        // Protobufè§£æå™¨
        class ProtobufParser {
            constructor(bytes) {
                this.bytes = bytes;
                this.offset = 0;
            }

            readVarint() {
                let value = 0;
                let shift = 0;
                while (this.offset < this.bytes.length) {
                    const byte = this.bytes[this.offset++];
                    value |= (byte & 0x7F) << shift;
                    if ((byte & 0x80) === 0) {
                        return value;
                    }
                    shift += 7;
                }
                throw new Error('Varint too long');
            }

            readFixed32() {
                if (this.offset + 4 > this.bytes.length) {
                    throw new Error('Not enough bytes for fixed32');
                }
                const view = new DataView(this.bytes.buffer, this.bytes.byteOffset + this.offset, 4);
                this.offset += 4;
                return view.getUint32(0, true); // little-endian
            }

            readFixed64() {
                if (this.offset + 8 > this.bytes.length) {
                    throw new Error('Not enough bytes for fixed64');
                }
                const view = new DataView(this.bytes.buffer, this.bytes.byteOffset + this.offset, 8);
                this.offset += 8;
                return view.getUint32(0, true);
            }

            readBytes(length) {
                if (this.offset + length > this.bytes.length) {
                    throw new Error('Not enough bytes');
                }
                const result = this.bytes.slice(this.offset, this.offset + length);
                this.offset += length;
                return result;
            }

            parseMessage() {
                const fields = {};

                while (this.offset < this.bytes.length) {
                    const tag = this.readVarint();
                    const fieldNumber = tag >>> 3;
                    const wireType = tag & 0x07;

                    let value;
                    switch (wireType) {
                        case WIRE_TYPES.VARINT:
                            value = this.readVarint();
                            break;
                        case WIRE_TYPES.FIXED64:
                            value = this.readFixed64();
                            break;
                        case WIRE_TYPES.LENGTH_DELIMITED:
                            const length = this.readVarint();
                            const bytes = this.readBytes(length);
                            try {
                                const parser = new ProtobufParser(bytes);
                                value = parser.parseMessage();
                            } catch (e) {
                                value = bytes;
                            }
                            break;
                        case WIRE_TYPES.FIXED32:
                            value = this.readFixed32();
                            break;
                        default:
                            throw new Error(`Unknown wire type: ${wireType}`);
                    }

                    if (fields[fieldNumber]) {
                        if (Array.isArray(fields[fieldNumber])) {
                            fields[fieldNumber].push(value);
                        } else {
                            fields[fieldNumber] = [fields[fieldNumber], value];
                        }
                    } else {
                        fields[fieldNumber] = value;
                    }
                }

                return fields;
            }
        }

        // Varintç¼–ç 
        function encodeVarint(value) {
            const bytes = [];
            while (value > 0x7f) {
                bytes.push((value & 0x7f) | 0x80);
                value >>>= 7;
            }
            bytes.push(value & 0x7f);
            return bytes;
        }

        // ç¼–ç Protobufæ¶ˆæ¯
        function encodeMessage(msgId, data = {}) {
            let protoData = new Uint8Array(0);

            if (msgId === 1801) {
                // m_1801_tos: è¿›å…¥æˆ¿é—´ï¼Œtype = 7 (freeæˆ¿é—´)
                const zooType = data.type || 7;
                const typeBytes = encodeVarint(zooType);
                protoData = new Uint8Array([0x08, ...typeBytes]); // field 1, varint
            } else if (msgId === 1815) {
                // m_1815_tos: å‘å°„å­å¼¹
                const fields = [];
                if (data.bulletId) {
                    fields.push(0x08, ...encodeVarint(data.bulletId)); // field 1
                }
                if (data.x !== undefined) {
                    fields.push(0x10, ...encodeVarint(data.x)); // field 2
                }
                if (data.y !== undefined) {
                    fields.push(0x18, ...encodeVarint(data.y)); // field 3
                }
                if (data.angle !== undefined) {
                    fields.push(0x20, ...encodeVarint(data.angle)); // field 4
                }
                protoData = new Uint8Array(fields);
            } else if (msgId === 2001) {
                // m_2001_tos: è·å–é…ç½®ï¼Œé€šå¸¸æ˜¯ç©ºæ¶ˆæ¯
                protoData = new Uint8Array(0);
            } else if (msgId === 2099) {
                // å¿ƒè·³æ¶ˆæ¯ï¼Œé€šå¸¸æ˜¯ç©ºæ¶ˆæ¯
                protoData = new Uint8Array(0);
            }

            // è®¡ç®—æ€»é•¿åº¦ï¼ˆ2å­—èŠ‚æ¶ˆæ¯ID + protobufæ•°æ®ï¼‰
            const totalLength = 2 + protoData.length;

            // åˆ›å»ºå®Œæ•´çš„æ¶ˆæ¯ç¼“å†²åŒº
            const buffer = new ArrayBuffer(4 + totalLength);
            const view = new DataView(buffer);
            const bytes = new Uint8Array(buffer);

            // å†™å…¥é•¿åº¦ï¼ˆ4å­—èŠ‚ï¼Œå¤§ç«¯åºï¼‰
            view.setUint32(0, totalLength, false);

            // å†™å…¥æ¶ˆæ¯IDï¼ˆ2å­—èŠ‚ï¼Œå¤§ç«¯åºï¼‰
            view.setUint16(4, msgId, false);

            // å†™å…¥protobufæ•°æ®
            bytes.set(protoData, 6);

            return buffer;
        }

        // è§£ç å®Œæ•´çš„Protobufæ¶ˆæ¯
        function decodeMessage(buffer) {
            if (buffer.byteLength < 6) {
                return {
                    msgId: 0,
                    data: {},
                    error: 'æ¶ˆæ¯å¤ªçŸ­ï¼Œæ— æ³•è§£æ'
                };
            }

            const view = new DataView(buffer);

            // è¯»å–é•¿åº¦ï¼ˆ4å­—èŠ‚ï¼‰
            const length = view.getUint32(0, false);

            // è¯»å–æ¶ˆæ¯IDï¼ˆ2å­—èŠ‚ï¼‰
            const msgId = view.getUint16(4, false);

            // è·å–æ•°æ®éƒ¨åˆ†
            const dataBytes = new Uint8Array(buffer, 6);

            let data = {};
            if (dataBytes.length > 0) {
                try {
                    const parser = new ProtobufParser(dataBytes);
                    data = parser.parseMessage();
                } catch (e) {
                    data = { parseError: e.message, raw: Array.from(dataBytes) };
                }
            }

            return { msgId, data };
        }

        function connect() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                log('å·²ç»è¿æ¥', 'info');
                return;
            }

            const gameType = document.getElementById('gameType').value;
            const serverUrl = document.getElementById('serverUrl').value;
            const url = serverUrl + (serverUrl.includes('?') ? '&' : '?') + 'game=' + gameType;

            log(`è¿æ¥åˆ°: ${url}`, 'info');

            ws = new WebSocket(url);
            ws.binaryType = 'arraybuffer';

            ws.onopen = () => {
                log('WebSocketè¿æ¥æˆåŠŸ', 'info');
                updateStatus(true);
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('disconnectBtn').disabled = false;

                // å¯åŠ¨å¿ƒè·³
                startHeartbeat();

                // å¯åŠ¨è¿æ¥è®¡æ—¶å™¨
                connectionStartTime = Date.now();
                connectionTimer = setInterval(updateConnectionTime, 1000);

                // æ˜¾ç¤ºå¯¹åº”çš„æ“ä½œæŒ‰é’®
                if (gameType === 'slot') {
                    document.getElementById('slotActions').style.display = 'grid';
                    document.getElementById('animalActions').style.display = 'none';
                } else {
                    document.getElementById('slotActions').style.display = 'none';
                    document.getElementById('animalActions').style.display = 'grid';
                }

                // å‘é€åˆå§‹åŒ–æ¶ˆæ¯è·å–é…ç½®
                setTimeout(() => {
                    sendMessage(2001, {}); // è·å–é…ç½®
                    if (gameType === 'animal') {
                        sendMessage(1801, {type: 7}); // è¿›å…¥Freeæˆ¿é—´
                    }
                }, 500);
            };

            ws.onmessage = (event) => {
                if (event.data instanceof ArrayBuffer) {
                    const message = decodeMessage(event.data);
                    handleMessage(message.msgId, message.data);
                } else {
                    log('æ”¶åˆ°éäºŒè¿›åˆ¶æ¶ˆæ¯', 'error');
                }
            };

            ws.onerror = (error) => {
                log(`WebSocketé”™è¯¯: ${error}`, 'error');
            };

            ws.onclose = () => {
                log('WebSocketè¿æ¥å…³é—­', 'info');
                updateStatus(false);
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
                stopHeartbeat();
                if (connectionTimer) {
                    clearInterval(connectionTimer);
                    connectionTimer = null;
                }
                if (jackpotUpdateInterval) {
                    clearInterval(jackpotUpdateInterval);
                    jackpotUpdateInterval = null;
                }
            };
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        function sendMessage(msgId, data) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('WebSocketæœªè¿æ¥', 'error');
                return;
            }

            const buffer = encodeMessage(msgId, data);
            ws.send(buffer);
            log(`å‘é€ [${msgId}]: ${JSON.stringify(data)}`, 'send');
        }

        // æ ¼å¼åŒ–Protobufå­—æ®µä¸ºäººç±»å¯è¯»
        function formatProtobufFields(msgId, fields, indent = '') {
            const fieldNames = FIELD_NAMES[msgId] || {};
            let html = '';

            for (const [fieldNum, value] of Object.entries(fields)) {
                const fieldName = fieldNames[fieldNum] || `field_${fieldNum}`;

                if (value instanceof Uint8Array) {
                    // å­—èŠ‚æ•°ç»„ï¼Œå¯èƒ½æ˜¯åµŒå¥—æ¶ˆæ¯
                    try {
                        const parser = new ProtobufParser(value);
                        const nestedFields = parser.parseMessage();
                        html += `${indent}${fieldName}: [åµŒå¥—æ¶ˆæ¯] ${JSON.stringify(nestedFields)}<br>`;
                    } catch (e) {
                        const hex = Array.from(value).map(b => b.toString(16).padStart(2, '0')).join(' ');
                        html += `${indent}${fieldName}: ${hex} [bytes]<br>`;
                    }
                } else if (typeof value === 'object' && !Array.isArray(value)) {
                    html += `${indent}${fieldName}: ${JSON.stringify(value)}<br>`;
                } else if (Array.isArray(value)) {
                    html += `${indent}${fieldName}: [${value.join(', ')}]<br>`;
                } else {
                    html += `${indent}${fieldName}: ${value}<br>`;
                }
            }

            return html;
        }

        function handleMessage(msgId, data) {
            // ç‰¹æ®Šå¤„ç†ä¸åŒç±»å‹çš„æ¶ˆæ¯
            switch (msgId) {
                case 2099: // å¿ƒè·³å“åº”
                    log(`æ”¶åˆ°å¿ƒè·³å“åº” [${msgId}]`, 'heartbeat');
                    document.getElementById('heartbeatIndicator').style.background = '#00ff00';
                    setTimeout(() => {
                        document.getElementById('heartbeatIndicator').style.background = '#00ff00';
                    }, 500);
                    break;

                case 2001: // é…ç½®å“åº”
                    log(`æ”¶åˆ°é…ç½® [${msgId}]: ${formatProtobufFields(msgId, data)}`, 'receive');
                    if (data[1]) { // role_id
                        document.getElementById('playerId').textContent = data[1];
                    }
                    if (data[2] !== undefined) { // balance
                        document.getElementById('balance').textContent = data[2];
                    }
                    // æ˜¾ç¤ºå½©é‡‘é¢æ¿
                    document.getElementById('jackpotPanel').style.display = 'block';
                    startJackpotUpdate();
                    break;

                case 1801: // è¿›å…¥æˆ¿é—´å“åº”
                    log(`è¿›å…¥æˆ¿é—´å“åº” [${msgId}]: ${formatProtobufFields(msgId, data)}`, 'receive');
                    if (data[3]) { // animals
                        log(`ğŸ¾ æ£€æµ‹åˆ°åŠ¨ç‰©æ•°æ®: ${Array.isArray(data[3]) ? data[3].length : '1'} ä¸ªåŠ¨ç‰©`, 'info');
                    }
                    break;

                case 1815: // å°„å‡»å“åº”
                    log(`å°„å‡»å“åº” [${msgId}]: ${formatProtobufFields(msgId, data)}`, 'receive');
                    if (data[2]) { // hit_animals
                        log(`ğŸ¯ å‡»ä¸­åŠ¨ç‰©! å¥–åŠ±: ${data[3] || 0}`, 'jackpot');
                    }
                    break;

                case 1810: // å½©é‡‘æ¨é€
                    log(`å½©é‡‘æ›´æ–° [${msgId}]: ${JSON.stringify(data)}`, 'jackpot');
                    if (data.Bonus) {
                        currentJackpot = data.Bonus;
                        document.getElementById('jackpotAmount').textContent = 'Â¥' + data.Bonus;
                    }
                    break;

                case 1811: // å½©é‡‘ä¸­å¥–
                    log(`ğŸ‰ æ­å–œä¸­å¥–! [${msgId}]: ${JSON.stringify(data)}`, 'jackpot');
                    if (data.Bonus) {
                        alert(`æ­å–œæ‚¨ä¸­å¾—å½©é‡‘: Â¥${data.Bonus}!`);
                    }
                    break;

                case 1812: // å½©é‡‘å†å²
                    log(`å½©é‡‘å†å² [${msgId}]: ${formatProtobufFields(msgId, data)}`, 'receive');
                    break;

                case 1802: // Animalæˆ¿é—´ä¿¡æ¯
                    log(`æˆ¿é—´ä¿¡æ¯ [${msgId}]: ${formatProtobufFields(msgId, data)}`, 'receive');
                    break;

                default:
                    log(`æ”¶åˆ° [${msgId}]: ${formatProtobufFields(msgId, data)}`, 'receive');
                    break;
            }
        }

        function startHeartbeat() {
            heartbeatCount = 0;
            heartbeatInterval = setInterval(() => {
                sendMessage(2099, {}); // ä½¿ç”¨æ­£ç¡®çš„å¿ƒè·³æ¶ˆæ¯ID
                heartbeatCount++;
                document.getElementById('heartbeatCount').textContent = heartbeatCount;
            }, 15000); // æ¯15ç§’å‘é€ä¸€æ¬¡å¿ƒè·³
        }

        function stopHeartbeat() {
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
            }
            heartbeatCount = 0;
            document.getElementById('heartbeatCount').textContent = '0';
        }

        function startJackpotUpdate() {
            // æ¨¡æ‹Ÿå½©é‡‘å¢é•¿
            jackpotUpdateInterval = setInterval(() => {
                if (currentJackpot > 0) {
                    currentJackpot += Math.random() * 10;
                    document.getElementById('jackpotAmount').textContent = 'Â¥' + currentJackpot.toFixed(2);
                }
            }, 1000);

            // æ¯30ç§’è¯·æ±‚ä¸€æ¬¡å½©é‡‘æ›´æ–°
            setInterval(() => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    const gameType = document.getElementById('gameType').value;
                    if (gameType === 'animal') {
                        sendMessage(1812, {}); // è¯·æ±‚å½©é‡‘å†å²
                    }
                }
            }, 30000);
        }

        function updateConnectionTime() {
            if (connectionStartTime) {
                const seconds = Math.floor((Date.now() - connectionStartTime) / 1000);
                document.getElementById('connectionTime').textContent = seconds + 's';
            }
        }

        function updateStatus(connected) {
            const status = document.getElementById('status');
            if (connected) {
                status.className = 'status connected';
                status.textContent = 'å·²è¿æ¥';
            } else {
                status.className = 'status disconnected';
                status.textContent = 'æœªè¿æ¥';
                document.getElementById('jackpotPanel').style.display = 'none';
            }
        }

        function sendCustomMessage() {
            const msgId = parseInt(document.getElementById('customMsgId').value);
            const dataStr = document.getElementById('customData').value;

            if (!msgId) {
                log('è¯·è¾“å…¥æ¶ˆæ¯ID', 'error');
                return;
            }

            try {
                const data = JSON.parse(dataStr);
                sendMessage(msgId, data);
            } catch (e) {
                log('JSONæ ¼å¼é”™è¯¯: ' + e.message, 'error');
            }
        }

        function setTemplate(msgId, dataStr) {
            document.getElementById('customMsgId').value = msgId;
            document.getElementById('customData').value = dataStr;
        }

        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const entry = document.createElement('div');
            entry.className = 'log-entry log-' + type;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            output.appendChild(entry);
            output.scrollTop = output.scrollHeight;
        }

        function clearLog() {
            document.getElementById('output').innerHTML = '';
        }

        // æ¸¸æˆç±»å‹åˆ‡æ¢
        document.getElementById('gameType').addEventListener('change', (e) => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                log('è¯·å…ˆæ–­å¼€è¿æ¥å†åˆ‡æ¢æ¸¸æˆç±»å‹', 'error');
                e.target.value = e.target.value === 'slot' ? 'animal' : 'slot';
            }
        });

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        window.onload = () => {
            log('æµ‹è¯•å·¥å…·å·²å°±ç»ª', 'info');
            log('æ”¯æŒProtobufäºŒè¿›åˆ¶åè®®', 'info');
            log('å¿ƒè·³æœºåˆ¶å·²å¯ç”¨ (2099)', 'info');
            log('å½©é‡‘ç³»ç»Ÿå·²é›†æˆ', 'info');
        };
    </script>
</body>
</html>