<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>统一游戏测试工具</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 300px 1fr 400px;
            gap: 20px;
        }

        .panel {
            background: #2a2a2a;
            border: 1px solid #00ff00;
            border-radius: 5px;
            padding: 15px;
        }

        h1, h2, h3 {
            color: #00ff00;
            text-shadow: 0 0 10px #00ff00;
            margin: 0 0 15px 0;
        }

        .control-group {
            margin-bottom: 15px;
            padding: 10px;
            background: #1e1e1e;
            border-radius: 3px;
        }

        label {
            display: inline-block;
            width: 120px;
            color: #00ffff;
        }

        input, select, button {
            background: #1e1e1e;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 5px 10px;
            font-family: inherit;
            width: calc(100% - 130px);
            margin-top: 5px;
        }

        button {
            cursor: pointer;
            width: 100%;
            margin: 5px 0;
            transition: all 0.3s;
        }

        button:hover {
            background: #00ff00;
            color: #1e1e1e;
            box-shadow: 0 0 10px #00ff00;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #output {
            height: 500px;
            overflow-y: auto;
            background: #1e1e1e;
            padding: 10px;
            font-size: 12px;
            border-radius: 3px;
        }

        .log-entry {
            margin: 2px 0;
            padding: 2px 5px;
        }

        .log-send { color: #00ffff; }
        .log-receive { color: #ffff00; }
        .log-error { color: #ff0000; }
        .log-info { color: #00ff00; }
        .log-heartbeat { color: #ff00ff; }
        .log-jackpot { color: #ffd700; text-shadow: 0 0 5px #ffd700; }

        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 3px;
            margin-right: 10px;
        }

        .status.connected {
            background: #00ff00;
            color: #1e1e1e;
        }

        .status.disconnected {
            background: #ff0000;
            color: white;
        }

        .quick-action {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
        }

        .jackpot-panel {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #1e1e1e;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 0 20px #ffd700;
        }

        .jackpot-amount {
            font-size: 32px;
            font-weight: bold;
            margin: 10px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .heartbeat-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background: #00ff00;
            border-radius: 50%;
            margin-left: 10px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }

        .message-templates {
            max-height: 300px;
            overflow-y: auto;
        }

        .template-button {
            font-size: 11px;
            padding: 3px 5px;
            margin: 2px;
        }
    </style>
</head>
<body>
    <h1>🎮 统一游戏测试工具 - Protobuf版本</h1>

    <div class="container">
        <!-- 左侧控制面板 -->
        <div class="panel">
            <h3>连接控制</h3>

            <div class="control-group">
                <label>服务器地址:</label>
                <input type="text" id="serverUrl" value="ws://localhost:8080/ws/game">
            </div>

            <div class="control-group">
                <label>游戏类型:</label>
                <select id="gameType">
                    <option value="slot">老虎机 (Slot)</option>
                    <option value="animal">动物游戏 (Animal)</option>
                </select>
            </div>

            <button id="connectBtn" onclick="connect()">连接服务器</button>
            <button id="disconnectBtn" onclick="disconnect()" disabled>断开连接</button>

            <div style="margin-top: 15px;">
                <span class="status disconnected" id="status">未连接</span>
                <span id="heartbeatStatus"></span>
            </div>

            <h3 style="margin-top: 20px;">快速操作</h3>

            <div id="slotActions" class="quick-action">
                <button onclick="sendMessage(1901, {})">开始游戏</button>
                <button onclick="sendMessage(1902, {bet: 100})">转动(100)</button>
                <button onclick="sendMessage(1904, {})">结算</button>
                <button onclick="sendMessage(1905, {})">历史记录</button>
            </div>

            <div id="animalActions" class="quick-action" style="display: none;">
                <button onclick="sendMessage(1801, {})">进入房间</button>
                <button onclick="sendMessage(1802, {})">退出房间</button>
                <button onclick="sendMessage(1803, {})">开火射击</button>
                <button onclick="sendMessage(1815, {bulletId: 1, x: 500, y: 300, angle: 45})">发射子弹</button>
                <button onclick="sendMessage(1812, {})">彩金历史</button>
            </div>

            <h3 style="margin-top: 20px;">配置操作</h3>
            <button onclick="sendMessage(2001, {})">获取配置</button>
            <button onclick="sendMessage(2099, {})">发送心跳</button>
            <button onclick="sendMessage(2002, {error: 'test error'})">报告错误</button>
        </div>

        <!-- 中间日志输出 -->
        <div class="panel">
            <h3>消息日志</h3>
            <button onclick="clearLog()" style="width: auto; padding: 5px 15px; margin-bottom: 10px;">清空日志</button>
            <div id="output"></div>
        </div>

        <!-- 右侧状态面板 -->
        <div class="panel">
            <!-- 彩金显示 -->
            <div class="jackpot-panel" id="jackpotPanel" style="display: none;">
                <h3>💰 彩金池</h3>
                <div class="jackpot-amount" id="jackpotAmount">¥0</div>
                <div style="font-size: 12px;">每30秒自动更新</div>
            </div>

            <h3>游戏状态</h3>
            <div class="control-group">
                <div>玩家ID: <span id="playerId">-</span></div>
                <div>余额: <span id="balance">-</span></div>
                <div>心跳: <span id="heartbeatCount">0</span> <span class="heartbeat-indicator" id="heartbeatIndicator"></span></div>
                <div>连接时长: <span id="connectionTime">0s</span></div>
            </div>

            <h3 style="margin-top: 20px;">自定义消息</h3>
            <div class="control-group">
                <label>消息ID:</label>
                <input type="number" id="customMsgId" placeholder="如: 1901">
            </div>

            <div class="control-group">
                <label>消息数据:</label>
                <textarea id="customData" style="width: 100%; height: 100px; font-family: inherit; background: #1e1e1e; color: #00ff00; border: 1px solid #00ff00;" placeholder='{"key": "value"}'>{}</textarea>
            </div>

            <button onclick="sendCustomMessage()">发送自定义消息</button>

            <h3 style="margin-top: 20px;">消息模板</h3>
            <div class="message-templates">
                <button class="template-button" onclick="setTemplate(1901, '{}')">1901-开始游戏</button>
                <button class="template-button" onclick="setTemplate(1902, '{\"bet\": 100, \"lines\": 25}')">1902-转动</button>
                <button class="template-button" onclick="setTemplate(1903, '{\"bet\": 100, \"count\": 10}')">1903-批量转动</button>
                <button class="template-button" onclick="setTemplate(1801, '{}')">1801-进入房间</button>
                <button class="template-button" onclick="setTemplate(1803, '{}')">1803-开火</button>
                <button class="template-button" onclick="setTemplate(2099, '{}')">2099-心跳</button>
                <button class="template-button" onclick="setTemplate(2001, '{}')">2001-获取配置</button>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let heartbeatInterval = null;
        let heartbeatCount = 0;
        let connectionStartTime = null;
        let connectionTimer = null;
        let jackpotUpdateInterval = null;
        let currentJackpot = 0;

        // Protobuf编码
        function encodeMessage(msgId, data) {
            const jsonStr = JSON.stringify(data || {});
            const encoder = new TextEncoder();
            const jsonBytes = encoder.encode(jsonStr);

            const totalLength = 2 + jsonBytes.length;
            const buffer = new ArrayBuffer(6 + jsonBytes.length);
            const view = new DataView(buffer);

            view.setUint32(0, totalLength, false);
            view.setUint16(4, msgId, false);
            new Uint8Array(buffer, 6).set(jsonBytes);

            return buffer;
        }

        // Protobuf解码
        function decodeMessage(buffer) {
            const view = new DataView(buffer);
            const length = view.getUint32(0, false);
            const msgId = view.getUint16(4, false);

            let data = {};
            if (buffer.byteLength > 6) {
                const decoder = new TextDecoder();
                const jsonBytes = new Uint8Array(buffer, 6);
                try {
                    const jsonStr = decoder.decode(jsonBytes);
                    data = JSON.parse(jsonStr);
                } catch (e) {
                    // 如果不是JSON，可能是真正的Protobuf，暂时返回原始数据
                    data = { raw: Array.from(jsonBytes) };
                }
            }

            return { msgId, data };
        }

        function connect() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                log('已经连接', 'info');
                return;
            }

            const gameType = document.getElementById('gameType').value;
            const serverUrl = document.getElementById('serverUrl').value;
            const url = serverUrl + (serverUrl.includes('?') ? '&' : '?') + 'game=' + gameType;

            log(`连接到: ${url}`, 'info');

            ws = new WebSocket(url);
            ws.binaryType = 'arraybuffer';

            ws.onopen = () => {
                log('WebSocket连接成功', 'info');
                updateStatus(true);
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('disconnectBtn').disabled = false;

                // 启动心跳
                startHeartbeat();

                // 启动连接计时器
                connectionStartTime = Date.now();
                connectionTimer = setInterval(updateConnectionTime, 1000);

                // 显示对应的操作按钮
                if (gameType === 'slot') {
                    document.getElementById('slotActions').style.display = 'grid';
                    document.getElementById('animalActions').style.display = 'none';
                } else {
                    document.getElementById('slotActions').style.display = 'none';
                    document.getElementById('animalActions').style.display = 'grid';
                }

                // 发送初始化消息获取配置
                setTimeout(() => {
                    sendMessage(2001, {}); // 获取配置
                    if (gameType === 'animal') {
                        sendMessage(1801, {}); // 进入房间
                    }
                }, 500);
            };

            ws.onmessage = (event) => {
                if (event.data instanceof ArrayBuffer) {
                    const message = decodeMessage(event.data);
                    handleMessage(message.msgId, message.data);
                } else {
                    log('收到非二进制消息', 'error');
                }
            };

            ws.onerror = (error) => {
                log(`WebSocket错误: ${error}`, 'error');
            };

            ws.onclose = () => {
                log('WebSocket连接关闭', 'info');
                updateStatus(false);
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
                stopHeartbeat();
                if (connectionTimer) {
                    clearInterval(connectionTimer);
                    connectionTimer = null;
                }
                if (jackpotUpdateInterval) {
                    clearInterval(jackpotUpdateInterval);
                    jackpotUpdateInterval = null;
                }
            };
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        function sendMessage(msgId, data) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('WebSocket未连接', 'error');
                return;
            }

            const buffer = encodeMessage(msgId, data);
            ws.send(buffer);
            log(`发送 [${msgId}]: ${JSON.stringify(data)}`, 'send');
        }

        function handleMessage(msgId, data) {
            // 特殊处理不同类型的消息
            switch (msgId) {
                case 2099: // 心跳响应
                    log(`收到心跳响应 [${msgId}]`, 'heartbeat');
                    document.getElementById('heartbeatIndicator').style.background = '#00ff00';
                    setTimeout(() => {
                        document.getElementById('heartbeatIndicator').style.background = '#00ff00';
                    }, 500);
                    break;

                case 2001: // 配置响应
                    log(`收到配置 [${msgId}]: ${JSON.stringify(data)}`, 'receive');
                    if (data.RoleId) {
                        document.getElementById('playerId').textContent = data.RoleId;
                    }
                    if (data.Balance !== undefined) {
                        document.getElementById('balance').textContent = data.Balance;
                    }
                    // 显示彩金面板
                    document.getElementById('jackpotPanel').style.display = 'block';
                    startJackpotUpdate();
                    break;

                case 1810: // 彩金推送
                    log(`彩金更新 [${msgId}]: ${JSON.stringify(data)}`, 'jackpot');
                    if (data.Bonus) {
                        currentJackpot = data.Bonus;
                        document.getElementById('jackpotAmount').textContent = '¥' + data.Bonus;
                    }
                    break;

                case 1811: // 彩金中奖
                    log(`🎉 恭喜中奖! [${msgId}]: ${JSON.stringify(data)}`, 'jackpot');
                    if (data.Bonus) {
                        alert(`恭喜您中得彩金: ¥${data.Bonus}!`);
                    }
                    break;

                case 1812: // 彩金历史
                    log(`彩金历史 [${msgId}]: ${JSON.stringify(data)}`, 'receive');
                    break;

                case 1802: // Animal房间信息
                    log(`房间信息 [${msgId}]: 玩家数=${data.PlayerCount || 0}`, 'receive');
                    break;

                default:
                    log(`收到 [${msgId}]: ${JSON.stringify(data)}`, 'receive');
                    break;
            }
        }

        function startHeartbeat() {
            heartbeatCount = 0;
            heartbeatInterval = setInterval(() => {
                sendMessage(2099, {}); // 使用正确的心跳消息ID
                heartbeatCount++;
                document.getElementById('heartbeatCount').textContent = heartbeatCount;
            }, 15000); // 每15秒发送一次心跳
        }

        function stopHeartbeat() {
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
            }
            heartbeatCount = 0;
            document.getElementById('heartbeatCount').textContent = '0';
        }

        function startJackpotUpdate() {
            // 模拟彩金增长
            jackpotUpdateInterval = setInterval(() => {
                if (currentJackpot > 0) {
                    currentJackpot += Math.random() * 10;
                    document.getElementById('jackpotAmount').textContent = '¥' + currentJackpot.toFixed(2);
                }
            }, 1000);

            // 每30秒请求一次彩金更新
            setInterval(() => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    const gameType = document.getElementById('gameType').value;
                    if (gameType === 'animal') {
                        sendMessage(1812, {}); // 请求彩金历史
                    }
                }
            }, 30000);
        }

        function updateConnectionTime() {
            if (connectionStartTime) {
                const seconds = Math.floor((Date.now() - connectionStartTime) / 1000);
                document.getElementById('connectionTime').textContent = seconds + 's';
            }
        }

        function updateStatus(connected) {
            const status = document.getElementById('status');
            if (connected) {
                status.className = 'status connected';
                status.textContent = '已连接';
            } else {
                status.className = 'status disconnected';
                status.textContent = '未连接';
                document.getElementById('jackpotPanel').style.display = 'none';
            }
        }

        function sendCustomMessage() {
            const msgId = parseInt(document.getElementById('customMsgId').value);
            const dataStr = document.getElementById('customData').value;

            if (!msgId) {
                log('请输入消息ID', 'error');
                return;
            }

            try {
                const data = JSON.parse(dataStr);
                sendMessage(msgId, data);
            } catch (e) {
                log('JSON格式错误: ' + e.message, 'error');
            }
        }

        function setTemplate(msgId, dataStr) {
            document.getElementById('customMsgId').value = msgId;
            document.getElementById('customData').value = dataStr;
        }

        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const entry = document.createElement('div');
            entry.className = 'log-entry log-' + type;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            output.appendChild(entry);
            output.scrollTop = output.scrollHeight;
        }

        function clearLog() {
            document.getElementById('output').innerHTML = '';
        }

        // 游戏类型切换
        document.getElementById('gameType').addEventListener('change', (e) => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                log('请先断开连接再切换游戏类型', 'error');
                e.target.value = e.target.value === 'slot' ? 'animal' : 'slot';
            }
        });

        // 页面加载时的初始化
        window.onload = () => {
            log('测试工具已就绪', 'info');
            log('支持Protobuf二进制协议', 'info');
            log('心跳机制已启用 (2099)', 'info');
            log('彩金系统已集成', 'info');
        };
    </script>
</body>
</html>