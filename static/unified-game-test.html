<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎮 统一游戏测试工具 - Slot & Animal 双游戏</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        h1 {
            color: #333;
            text-align: center;
            font-size: 28px;
            margin-bottom: 20px;
        }

        .game-selector {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .game-btn {
            padding: 12px 30px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .game-btn.slot {
            background: linear-gradient(135deg, #ff6b6b, #ff8e53);
            color: white;
        }

        .game-btn.animal {
            background: linear-gradient(135deg, #48c774, #3298dc);
            color: white;
        }

        .game-btn.active {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 8px;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dc3545;
        }

        .status-indicator.connected {
            background: #28a745;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
        }

        .main-content {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 20px;
        }

        .control-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .game-controls {
            margin-top: 20px;
        }

        .control-section {
            margin-bottom: 25px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
        }

        .control-section h3 {
            color: #667eea;
            font-size: 16px;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e0e0e0;
        }

        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #48c774, #3298dc);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b, #ff8e53);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffdd57, #ff9f43);
            color: #333;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .message-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .message-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            color: #666;
            font-size: 14px;
            position: relative;
        }

        .tab.active {
            color: #667eea;
            font-weight: bold;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: #667eea;
        }

        .message-container {
            height: 600px;
            overflow-y: auto;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 8px;
        }

        .message {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 8px;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .message.sent {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-left: 4px solid #4caf50;
        }

        .message.received {
            background: linear-gradient(135deg, #f1f8e9 0%, #dcedc8 100%);
            border-left: 4px solid #8bc34a;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .message-type {
            font-weight: bold;
            color: #333;
        }

        .message-time {
            color: #999;
            font-size: 12px;
        }

        .message-content {
            color: #555;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-size: 14px;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .balance-display {
            display: flex;
            justify-content: space-around;
            padding: 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .balance-item {
            text-align: center;
        }

        .balance-label {
            font-size: 12px;
            opacity: 0.9;
        }

        .balance-value {
            font-size: 20px;
            font-weight: bold;
            margin-top: 5px;
        }

        /* Slot游戏特有样式 */
        .slot-controls {
            display: none;
        }

        .slot-controls.active {
            display: block;
        }

        /* Animal游戏特有样式 */
        .animal-controls {
            display: none;
        }

        .animal-controls.active {
            display: block;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .room-info {
            padding: 10px;
            background: #f0f0f0;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .animal-list {
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 5px;
        }

        .animal-item {
            padding: 5px;
            margin: 2px 0;
            background: white;
            border-radius: 3px;
            display: flex;
            justify-content: space-between;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 头部 -->
        <div class="header">
            <h1>🎮 统一游戏测试工具 - Slot & Animal 双游戏互通</h1>

            <!-- 游戏切换按钮 -->
            <div class="game-selector">
                <button class="game-btn slot active" onclick="switchGame('slot')">
                    🎰 老虎机游戏
                </button>
                <button class="game-btn animal" onclick="switchGame('animal')">
                    🦁 疯狂动物园
                </button>
            </div>

            <!-- 状态栏 -->
            <div class="status-bar">
                <div class="status">
                    <span class="status-indicator" id="connectionStatus"></span>
                    <span id="connectionText">未连接</span>
                    <span style="margin-left: 20px;">当前游戏: <strong id="currentGame">老虎机</strong></span>
                </div>
                <div class="status">
                    <span>会话ID: <strong id="sessionId">-</strong></span>
                    <span style="margin-left: 20px;">玩家ID: <strong id="playerId">-</strong></span>
                </div>
            </div>

            <!-- 余额显示 -->
            <div class="balance-display">
                <div class="balance-item">
                    <div class="balance-label">💰 金币</div>
                    <div class="balance-value" id="goldBalance">0</div>
                </div>
                <div class="balance-item">
                    <div class="balance-label">🎁 免费金币</div>
                    <div class="balance-value" id="freeGoldBalance">0</div>
                </div>
                <div class="balance-item">
                    <div class="balance-label">🎯 总赢取</div>
                    <div class="balance-value" id="totalWin">0</div>
                </div>
            </div>
        </div>

        <!-- 主内容区 -->
        <div class="main-content">
            <!-- 控制面板 -->
            <div class="control-panel">
                <!-- 连接控制 -->
                <div class="control-section">
                    <h3>🔌 连接设置</h3>
                    <div class="input-group">
                        <label>WebSocket URL</label>
                        <input type="text" id="wsUrl" value="ws://localhost:8080/ws/game?game=unified" readonly>
                    </div>
                    <div class="input-group">
                        <label>玩家名称</label>
                        <input type="text" id="playerName" value="测试玩家" placeholder="输入玩家名称">
                    </div>
                    <button id="connectBtn" class="btn btn-primary" onclick="connect()">连接服务器</button>
                    <button id="disconnectBtn" class="btn btn-danger" onclick="disconnect()" disabled>断开连接</button>
                </div>

                <!-- 通用操作 -->
                <div class="control-section">
                    <h3>🎮 通用操作</h3>
                    <button class="btn btn-success" onclick="sendLogin()">登录</button>
                    <button class="btn btn-warning" onclick="sendHeartbeat()">心跳</button>
                </div>

                <!-- Slot游戏控制 -->
                <div class="control-section slot-controls active">
                    <h3>🎰 老虎机控制</h3>
                    <div class="input-group">
                        <label>下注金额</label>
                        <select id="slotBetAmount">
                            <option value="100">100</option>
                            <option value="200">200</option>
                            <option value="500">500</option>
                            <option value="1000">1000</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="slotEnterRoom()">进入Slot房间</button>
                    <button class="btn btn-success" onclick="slotSpin()">开始转动</button>
                    <button class="btn btn-warning" onclick="slotAutoSpin()">自动转动(20次)</button>
                    <button class="btn btn-danger" onclick="slotStopAuto()">停止自动</button>
                </div>

                <!-- Animal游戏控制 -->
                <div class="control-section animal-controls">
                    <h3>🦁 动物园控制</h3>
                    <div class="input-group">
                        <label>场次选择</label>
                        <select id="animalZooType">
                            <option value="1">平民场</option>
                            <option value="2">中级场</option>
                            <option value="3">土豪场</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="animalEnterRoom()">进入Animal房间</button>
                    <button class="btn btn-danger" onclick="animalLeaveRoom()">离开房间</button>

                    <div style="margin-top: 15px;">
                        <h4>射击控制</h4>
                        <div class="input-group">
                            <label>目标动物ID</label>
                            <input type="number" id="animalTargetId" value="1" min="1">
                        </div>
                        <div class="input-group">
                            <label>子弹等级</label>
                            <select id="animalBulletLevel">
                                <option value="100">普通(100)</option>
                                <option value="500">高级(500)</option>
                                <option value="1000">超级(1000)</option>
                            </select>
                        </div>
                        <button class="btn btn-success" onclick="animalFire()">开火射击</button>
                        <button class="btn btn-warning" onclick="animalRapidFire()">连续射击(10发)</button>
                    </div>

                    <!-- 房间内动物列表 -->
                    <div style="margin-top: 15px;">
                        <h4>房间动物</h4>
                        <div class="animal-list" id="animalList">
                            暂无动物
                        </div>
                    </div>
                </div>
            </div>

            <!-- 消息面板 -->
            <div class="message-panel">
                <div class="message-tabs">
                    <button class="tab active" onclick="switchTab('all')">全部消息</button>
                    <button class="tab" onclick="switchTab('sent')">发送消息</button>
                    <button class="tab" onclick="switchTab('received')">接收消息</button>
                    <button class="tab" onclick="switchTab('slot')">Slot消息</button>
                    <button class="tab" onclick="switchTab('animal')">Animal消息</button>
                </div>

                <div class="message-container" id="messageContainer">
                    <!-- 消息将显示在这里 -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // WebSocket连接
        let ws = null;
        let isConnected = false;
        let currentGameMode = 'slot';
        let sessionInfo = {};
        let autoSpinTimer = null;
        let rapidFireTimer = null;

        // 余额信息
        let gameBalance = {
            gold: 0,
            freeGold: 0,
            totalWin: 0
        };

        // 房间内动物列表
        let roomAnimals = {};

        // 消息类型映射
        const messageNames = {
            // 通用消息
            1001: '心跳',
            1006: '登录',

            // Slot消息
            1900: 'Slot开始游戏',
            1901: 'Slot进入房间',
            1902: 'Slot游戏结果',
            1903: 'Slot余额更新',
            1910: 'Slot获取JP池',

            // Animal消息
            1801: 'Animal进入房间',
            1802: 'Animal离开房间',
            1803: 'Animal开火',
            1805: 'Animal使用技能',
            1807: 'Animal场次信息',
            1884: 'Animal动物死亡',
            1887: 'Animal动物进入',
            1888: 'Animal动物离开',

            // 特殊消息
            9903: 'Slot触发Animal'
        };

        // 切换游戏模式
        function switchGame(game) {
            currentGameMode = game;

            // 更新UI
            document.querySelectorAll('.game-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.game-btn.${game}`).classList.add('active');

            document.getElementById('currentGame').textContent = game === 'slot' ? '老虎机' : '疯狂动物园';

            // 切换控制面板
            document.querySelectorAll('.slot-controls').forEach(el => {
                el.classList.toggle('active', game === 'slot');
            });
            document.querySelectorAll('.animal-controls').forEach(el => {
                el.classList.toggle('active', game === 'animal');
            });

            addMessage('system', `切换到${game === 'slot' ? '老虎机' : '疯狂动物园'}游戏`);
        }

        // 连接WebSocket
        function connect() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                console.log('已经连接');
                return;
            }

            const url = document.getElementById('wsUrl').value;
            const name = document.getElementById('playerName').value;

            // 添加参数
            const finalUrl = `${url}&name=${encodeURIComponent(name)}`;

            ws = new WebSocket(finalUrl);
            ws.binaryType = 'arraybuffer';

            ws.onopen = () => {
                isConnected = true;
                updateConnectionStatus(true);
                addMessage('system', '连接成功！');

                // 自动登录
                setTimeout(sendLogin, 500);
            };

            ws.onmessage = (event) => {
                handleMessage(event.data);
            };

            ws.onerror = (error) => {
                console.error('WebSocket错误:', error);
                addMessage('error', `连接错误: ${error}`);
            };

            ws.onclose = () => {
                isConnected = false;
                updateConnectionStatus(false);
                addMessage('system', '连接已断开');
            };
        }

        // 断开连接
        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
            stopAutoSpin();
            stopRapidFire();
        }

        // 更新连接状态
        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('connectionStatus');
            const text = document.getElementById('connectionText');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');

            if (connected) {
                indicator.classList.add('connected');
                text.textContent = '已连接';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            } else {
                indicator.classList.remove('connected');
                text.textContent = '未连接';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            }
        }

        // 发送消息
        function sendMessage(msgId, data = {}) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                addMessage('error', '未连接到服务器');
                return;
            }

            // 编码消息
            const encoded = encodeMessage(msgId, data);
            ws.send(encoded);

            addMessage('sent', `${messageNames[msgId] || 'Unknown'} (${msgId})`, data);
        }

        // 编码消息
        function encodeMessage(msgId, data) {
            // 简化的消息编码（实际应该使用protobuf）
            const jsonStr = JSON.stringify(data);
            const jsonBytes = new TextEncoder().encode(jsonStr);

            const buffer = new ArrayBuffer(8 + jsonBytes.length);
            const view = new DataView(buffer);

            // 消息ID (4字节)
            view.setUint32(0, msgId, true);

            // 数据长度 (4字节)
            view.setUint32(4, jsonBytes.length, true);

            // 数据内容
            new Uint8Array(buffer, 8).set(jsonBytes);

            return buffer;
        }

        // 处理接收的消息
        function handleMessage(data) {
            const view = new DataView(data);

            if (data.byteLength < 8) {
                console.error('消息太短');
                return;
            }

            const msgId = view.getUint32(0, true);
            const dataLength = view.getUint32(4, true);

            // 解析数据（简化处理）
            let msgData = {};
            if (dataLength > 0 && data.byteLength >= 8 + dataLength) {
                try {
                    const jsonBytes = new Uint8Array(data, 8, dataLength);
                    const jsonStr = new TextDecoder().decode(jsonBytes);
                    msgData = JSON.parse(jsonStr);
                } catch (e) {
                    // 如果不是JSON，尝试其他解析方式
                    msgData = { raw: Array.from(new Uint8Array(data, 8, dataLength)) };
                }
            }

            // 处理特定消息
            handleSpecificMessage(msgId, msgData);

            // 添加到消息列表
            const messageName = messageNames[msgId] || `Unknown(${msgId})`;
            addMessage('received', messageName, msgData);
        }

        // 处理特定消息
        function handleSpecificMessage(msgId, data) {
            switch(msgId) {
                case 1006: // 登录响应
                    sessionInfo.playerId = data.roleId;
                    sessionInfo.name = data.name;
                    gameBalance.gold = data.gold || 0;
                    gameBalance.freeGold = data.freeGold || 0;
                    updateUI();
                    break;

                case 1903: // Slot余额更新
                    gameBalance.gold = data.gold || gameBalance.gold;
                    gameBalance.freeGold = data.freeGold || gameBalance.freeGold;
                    updateUI();
                    break;

                case 1902: // Slot游戏结果
                    if (data.prize) {
                        gameBalance.totalWin += data.prize;
                        updateUI();
                    }
                    break;

                case 1887: // Animal动物进入
                    if (data.animal) {
                        data.animal.forEach(animal => {
                            roomAnimals[animal.id] = animal;
                        });
                        updateAnimalList();
                    }
                    break;

                case 1888: // Animal动物离开
                    if (data.id && roomAnimals[data.id]) {
                        delete roomAnimals[data.id];
                        updateAnimalList();
                    }
                    break;

                case 1884: // Animal动物死亡
                    if (data.ids) {
                        data.ids.forEach(deadAnimal => {
                            delete roomAnimals[deadAnimal.id];
                        });
                        updateAnimalList();
                    }
                    break;

                case 9903: // Slot触发Animal
                    addMessage('system', `🎉 触发Animal游戏！类型: ${data.type}, 回合: ${data.rounds}`);
                    // 自动切换到Animal游戏
                    setTimeout(() => switchGame('animal'), 1000);
                    break;
            }
        }

        // 更新UI
        function updateUI() {
            document.getElementById('playerId').textContent = sessionInfo.playerId || '-';
            document.getElementById('goldBalance').textContent = gameBalance.gold.toLocaleString();
            document.getElementById('freeGoldBalance').textContent = gameBalance.freeGold.toLocaleString();
            document.getElementById('totalWin').textContent = gameBalance.totalWin.toLocaleString();
        }

        // 更新动物列表
        function updateAnimalList() {
            const listEl = document.getElementById('animalList');

            if (Object.keys(roomAnimals).length === 0) {
                listEl.innerHTML = '暂无动物';
                return;
            }

            listEl.innerHTML = Object.values(roomAnimals).map(animal => `
                <div class="animal-item">
                    <span>ID: ${animal.id} - ${animal.animal || '未知'}</span>
                    <span>路线: ${animal.lv}</span>
                </div>
            `).join('');
        }

        // 添加消息到界面
        function addMessage(type, title, content = null) {
            const container = document.getElementById('messageContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;

            const time = new Date().toLocaleTimeString();

            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="message-type">${title}</span>
                    <span class="message-time">${time}</span>
                </div>
                ${content ? `<div class="message-content">${JSON.stringify(content, null, 2)}</div>` : ''}
            `;

            container.insertBefore(messageDiv, container.firstChild);

            // 限制消息数量
            while (container.children.length > 100) {
                container.removeChild(container.lastChild);
            }
        }

        // === 通用操作 ===
        function sendLogin() {
            sendMessage(1006, {
                name: document.getElementById('playerName').value,
                icon: '',
                password: ''
            });
        }

        function sendHeartbeat() {
            sendMessage(1001);
        }

        // === Slot游戏操作 ===
        function slotEnterRoom() {
            sendMessage(1901, { type: 1 }); // 麻将类型
        }

        function slotSpin() {
            const bet = parseInt(document.getElementById('slotBetAmount').value);
            sendMessage(1900, { betamount: bet });
        }

        function slotAutoSpin() {
            stopAutoSpin();
            let count = 0;
            const maxCount = 20;

            autoSpinTimer = setInterval(() => {
                if (count >= maxCount) {
                    stopAutoSpin();
                    return;
                }
                slotSpin();
                count++;
            }, 1000);
        }

        function slotStopAuto() {
            stopAutoSpin();
        }

        function stopAutoSpin() {
            if (autoSpinTimer) {
                clearInterval(autoSpinTimer);
                autoSpinTimer = null;
            }
        }

        // === Animal游戏操作 ===
        function animalEnterRoom() {
            const zoo = parseInt(document.getElementById('animalZooType').value);
            sendMessage(1801, { zoo });
        }

        function animalLeaveRoom() {
            sendMessage(1802);
            roomAnimals = {};
            updateAnimalList();
        }

        function animalFire() {
            const targetId = parseInt(document.getElementById('animalTargetId').value);
            const bet = parseInt(document.getElementById('animalBulletLevel').value);
            sendMessage(1803, { id: targetId, bet });
        }

        function animalRapidFire() {
            stopRapidFire();
            let count = 0;
            const maxCount = 10;

            rapidFireTimer = setInterval(() => {
                if (count >= maxCount) {
                    stopRapidFire();
                    return;
                }
                animalFire();
                count++;
            }, 200);
        }

        function stopRapidFire() {
            if (rapidFireTimer) {
                clearInterval(rapidFireTimer);
                rapidFireTimer = null;
            }
        }

        // 切换消息标签
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            // 这里可以添加消息过滤逻辑
            console.log('切换到标签:', tab);
        }

        // 页面加载完成后的初始化
        window.onload = () => {
            updateConnectionStatus(false);
        };

        // 页面关闭时断开连接
        window.onbeforeunload = () => {
            if (ws) {
                ws.close();
            }
        };
    </script>
</body>
</html>