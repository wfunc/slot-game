<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ® ç»Ÿä¸€æ¸¸æˆæµ‹è¯•å·¥å…· - Slot & Animal åŒæ¸¸æˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        h1 {
            color: #333;
            text-align: center;
            font-size: 28px;
            margin-bottom: 20px;
        }

        .game-selector {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .game-btn {
            padding: 12px 30px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .game-btn.slot {
            background: linear-gradient(135deg, #ff6b6b, #ff8e53);
            color: white;
        }

        .game-btn.animal {
            background: linear-gradient(135deg, #48c774, #3298dc);
            color: white;
        }

        .game-btn.active {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 8px;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dc3545;
        }

        .status-indicator.connected {
            background: #28a745;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
        }

        .main-content {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 20px;
        }

        .control-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .game-controls {
            margin-top: 20px;
        }

        .control-section {
            margin-bottom: 25px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
        }

        .control-section h3 {
            color: #667eea;
            font-size: 16px;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e0e0e0;
        }

        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #48c774, #3298dc);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b, #ff8e53);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffdd57, #ff9f43);
            color: #333;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .message-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .message-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            color: #666;
            font-size: 14px;
            position: relative;
        }

        .tab.active {
            color: #667eea;
            font-weight: bold;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: #667eea;
        }

        .message-container {
            height: 600px;
            overflow-y: auto;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 8px;
        }

        .message {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 8px;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .message.sent {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-left: 4px solid #4caf50;
        }

        .message.received {
            background: linear-gradient(135deg, #f1f8e9 0%, #dcedc8 100%);
            border-left: 4px solid #8bc34a;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .message-type {
            font-weight: bold;
            color: #333;
        }

        .message-time {
            color: #999;
            font-size: 12px;
        }

        .message-content {
            color: #555;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-size: 14px;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .balance-display {
            display: flex;
            justify-content: space-around;
            padding: 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .balance-item {
            text-align: center;
        }

        .balance-label {
            font-size: 12px;
            opacity: 0.9;
        }

        .balance-value {
            font-size: 20px;
            font-weight: bold;
            margin-top: 5px;
        }

        /* Slotæ¸¸æˆç‰¹æœ‰æ ·å¼ */
        .slot-controls {
            display: none;
        }

        .slot-controls.active {
            display: block;
        }

        /* Animalæ¸¸æˆç‰¹æœ‰æ ·å¼ */
        .animal-controls {
            display: none;
        }

        .animal-controls.active {
            display: block;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .room-info {
            padding: 10px;
            background: #f0f0f0;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .animal-list {
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 5px;
        }

        .animal-item {
            padding: 5px;
            margin: 2px 0;
            background: white;
            border-radius: 3px;
            display: flex;
            justify-content: space-between;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>ğŸ® ç»Ÿä¸€æ¸¸æˆæµ‹è¯•å·¥å…· - Slot & Animal åŒæ¸¸æˆäº’é€š</h1>

            <!-- æ¸¸æˆåˆ‡æ¢æŒ‰é’® -->
            <div class="game-selector">
                <button class="game-btn slot active" onclick="switchGame('slot')">
                    ğŸ° è€è™æœºæ¸¸æˆ
                </button>
                <button class="game-btn animal" onclick="switchGame('animal')">
                    ğŸ¦ ç–¯ç‹‚åŠ¨ç‰©å›­
                </button>
            </div>

            <!-- çŠ¶æ€æ  -->
            <div class="status-bar">
                <div class="status">
                    <span class="status-indicator" id="connectionStatus"></span>
                    <span id="connectionText">æœªè¿æ¥</span>
                    <span style="margin-left: 20px;">å½“å‰æ¸¸æˆ: <strong id="currentGame">è€è™æœº</strong></span>
                </div>
                <div class="status">
                    <span>ä¼šè¯ID: <strong id="sessionId">-</strong></span>
                    <span style="margin-left: 20px;">ç©å®¶ID: <strong id="playerId">-</strong></span>
                </div>
            </div>

            <!-- ä½™é¢æ˜¾ç¤º -->
            <div class="balance-display">
                <div class="balance-item">
                    <div class="balance-label">ğŸ’° é‡‘å¸</div>
                    <div class="balance-value" id="goldBalance">0</div>
                </div>
                <div class="balance-item">
                    <div class="balance-label">ğŸ å…è´¹é‡‘å¸</div>
                    <div class="balance-value" id="freeGoldBalance">0</div>
                </div>
                <div class="balance-item">
                    <div class="balance-label">ğŸ¯ æ€»èµ¢å–</div>
                    <div class="balance-value" id="totalWin">0</div>
                </div>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <!-- æ§åˆ¶é¢æ¿ -->
            <div class="control-panel">
                <!-- è¿æ¥æ§åˆ¶ -->
                <div class="control-section">
                    <h3>ğŸ”Œ è¿æ¥è®¾ç½®</h3>
                    <div class="input-group">
                        <label>WebSocket URL</label>
                        <input type="text" id="wsUrl" value="ws://localhost:8080/ws/game?game=unified" readonly>
                    </div>
                    <div class="input-group">
                        <label>ç©å®¶åç§°</label>
                        <input type="text" id="playerName" value="æµ‹è¯•ç©å®¶" placeholder="è¾“å…¥ç©å®¶åç§°">
                    </div>
                    <button id="connectBtn" class="btn btn-primary" onclick="connect()">è¿æ¥æœåŠ¡å™¨</button>
                    <button id="disconnectBtn" class="btn btn-danger" onclick="disconnect()" disabled>æ–­å¼€è¿æ¥</button>
                </div>

                <!-- é€šç”¨æ“ä½œ -->
                <div class="control-section">
                    <h3>ğŸ® é€šç”¨æ“ä½œ</h3>
                    <button class="btn btn-success" onclick="sendLogin()">ç™»å½•</button>
                    <button class="btn btn-warning" onclick="sendHeartbeat()">å¿ƒè·³</button>
                </div>

                <!-- Slotæ¸¸æˆæ§åˆ¶ -->
                <div class="control-section slot-controls active">
                    <h3>ğŸ° è€è™æœºæ§åˆ¶</h3>
                    <div class="input-group">
                        <label>ä¸‹æ³¨é‡‘é¢</label>
                        <select id="slotBetAmount">
                            <option value="100">100</option>
                            <option value="200">200</option>
                            <option value="500">500</option>
                            <option value="1000">1000</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="slotEnterRoom()">è¿›å…¥Slotæˆ¿é—´</button>
                    <button class="btn btn-success" onclick="slotSpin()">å¼€å§‹è½¬åŠ¨</button>
                    <button class="btn btn-warning" onclick="slotAutoSpin()">è‡ªåŠ¨è½¬åŠ¨(20æ¬¡)</button>
                    <button class="btn btn-danger" onclick="slotStopAuto()">åœæ­¢è‡ªåŠ¨</button>
                </div>

                <!-- Animalæ¸¸æˆæ§åˆ¶ -->
                <div class="control-section animal-controls">
                    <h3>ğŸ¦ åŠ¨ç‰©å›­æ§åˆ¶</h3>
                    <div class="input-group">
                        <label>åœºæ¬¡é€‰æ‹©</label>
                        <select id="animalZooType">
                            <option value="1">å¹³æ°‘åœº</option>
                            <option value="2">ä¸­çº§åœº</option>
                            <option value="3">åœŸè±ªåœº</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="animalEnterRoom()">è¿›å…¥Animalæˆ¿é—´</button>
                    <button class="btn btn-danger" onclick="animalLeaveRoom()">ç¦»å¼€æˆ¿é—´</button>

                    <div style="margin-top: 15px;">
                        <h4>å°„å‡»æ§åˆ¶</h4>
                        <div class="input-group">
                            <label>ç›®æ ‡åŠ¨ç‰©ID</label>
                            <input type="number" id="animalTargetId" value="1" min="1">
                        </div>
                        <div class="input-group">
                            <label>å­å¼¹ç­‰çº§</label>
                            <select id="animalBulletLevel">
                                <option value="100">æ™®é€š(100)</option>
                                <option value="500">é«˜çº§(500)</option>
                                <option value="1000">è¶…çº§(1000)</option>
                            </select>
                        </div>
                        <button class="btn btn-success" onclick="animalFire()">å¼€ç«å°„å‡»</button>
                        <button class="btn btn-warning" onclick="animalRapidFire()">è¿ç»­å°„å‡»(10å‘)</button>
                    </div>

                    <!-- æˆ¿é—´å†…åŠ¨ç‰©åˆ—è¡¨ -->
                    <div style="margin-top: 15px;">
                        <h4>æˆ¿é—´åŠ¨ç‰©</h4>
                        <div class="animal-list" id="animalList">
                            æš‚æ— åŠ¨ç‰©
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ¶ˆæ¯é¢æ¿ -->
            <div class="message-panel">
                <div class="message-tabs">
                    <button class="tab active" onclick="switchTab('all')">å…¨éƒ¨æ¶ˆæ¯</button>
                    <button class="tab" onclick="switchTab('sent')">å‘é€æ¶ˆæ¯</button>
                    <button class="tab" onclick="switchTab('received')">æ¥æ”¶æ¶ˆæ¯</button>
                    <button class="tab" onclick="switchTab('slot')">Slotæ¶ˆæ¯</button>
                    <button class="tab" onclick="switchTab('animal')">Animalæ¶ˆæ¯</button>
                </div>

                <div class="message-container" id="messageContainer">
                    <!-- æ¶ˆæ¯å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // WebSocketè¿æ¥
        let ws = null;
        let isConnected = false;
        let currentGameMode = 'slot';
        let sessionInfo = {};
        let autoSpinTimer = null;
        let rapidFireTimer = null;

        // ä½™é¢ä¿¡æ¯
        let gameBalance = {
            gold: 0,
            freeGold: 0,
            totalWin: 0
        };

        // æˆ¿é—´å†…åŠ¨ç‰©åˆ—è¡¨
        let roomAnimals = {};

        // æ¶ˆæ¯ç±»å‹æ˜ å°„
        const messageNames = {
            // é€šç”¨æ¶ˆæ¯
            1001: 'å¿ƒè·³',
            1006: 'ç™»å½•',

            // Slotæ¶ˆæ¯
            1900: 'Slotå¼€å§‹æ¸¸æˆ',
            1901: 'Slotè¿›å…¥æˆ¿é—´',
            1902: 'Slotæ¸¸æˆç»“æœ',
            1903: 'Slotä½™é¢æ›´æ–°',
            1910: 'Slotè·å–JPæ± ',

            // Animalæ¶ˆæ¯
            1801: 'Animalè¿›å…¥æˆ¿é—´',
            1802: 'Animalç¦»å¼€æˆ¿é—´',
            1803: 'Animalå¼€ç«',
            1805: 'Animalä½¿ç”¨æŠ€èƒ½',
            1807: 'Animalåœºæ¬¡ä¿¡æ¯',
            1884: 'AnimalåŠ¨ç‰©æ­»äº¡',
            1887: 'AnimalåŠ¨ç‰©è¿›å…¥',
            1888: 'AnimalåŠ¨ç‰©ç¦»å¼€',

            // ç‰¹æ®Šæ¶ˆæ¯
            9903: 'Slotè§¦å‘Animal'
        };

        // åˆ‡æ¢æ¸¸æˆæ¨¡å¼
        function switchGame(game) {
            currentGameMode = game;

            // æ›´æ–°UI
            document.querySelectorAll('.game-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.game-btn.${game}`).classList.add('active');

            document.getElementById('currentGame').textContent = game === 'slot' ? 'è€è™æœº' : 'ç–¯ç‹‚åŠ¨ç‰©å›­';

            // åˆ‡æ¢æ§åˆ¶é¢æ¿
            document.querySelectorAll('.slot-controls').forEach(el => {
                el.classList.toggle('active', game === 'slot');
            });
            document.querySelectorAll('.animal-controls').forEach(el => {
                el.classList.toggle('active', game === 'animal');
            });

            addMessage('system', `åˆ‡æ¢åˆ°${game === 'slot' ? 'è€è™æœº' : 'ç–¯ç‹‚åŠ¨ç‰©å›­'}æ¸¸æˆ`);
        }

        // è¿æ¥WebSocket
        function connect() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                console.log('å·²ç»è¿æ¥');
                return;
            }

            const url = document.getElementById('wsUrl').value;
            const name = document.getElementById('playerName').value;

            // æ·»åŠ å‚æ•°
            const finalUrl = `${url}&name=${encodeURIComponent(name)}`;

            ws = new WebSocket(finalUrl);
            ws.binaryType = 'arraybuffer';

            ws.onopen = () => {
                isConnected = true;
                updateConnectionStatus(true);
                addMessage('system', 'è¿æ¥æˆåŠŸï¼');

                // è‡ªåŠ¨ç™»å½•
                setTimeout(sendLogin, 500);
            };

            ws.onmessage = (event) => {
                handleMessage(event.data);
            };

            ws.onerror = (error) => {
                console.error('WebSocketé”™è¯¯:', error);
                addMessage('error', `è¿æ¥é”™è¯¯: ${error}`);
            };

            ws.onclose = () => {
                isConnected = false;
                updateConnectionStatus(false);
                addMessage('system', 'è¿æ¥å·²æ–­å¼€');
            };
        }

        // æ–­å¼€è¿æ¥
        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
            stopAutoSpin();
            stopRapidFire();
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('connectionStatus');
            const text = document.getElementById('connectionText');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');

            if (connected) {
                indicator.classList.add('connected');
                text.textContent = 'å·²è¿æ¥';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            } else {
                indicator.classList.remove('connected');
                text.textContent = 'æœªè¿æ¥';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            }
        }

        // å‘é€æ¶ˆæ¯
        function sendMessage(msgId, data = {}) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                addMessage('error', 'æœªè¿æ¥åˆ°æœåŠ¡å™¨');
                return;
            }

            // ç¼–ç æ¶ˆæ¯
            const encoded = encodeMessage(msgId, data);
            ws.send(encoded);

            addMessage('sent', `${messageNames[msgId] || 'Unknown'} (${msgId})`, data);
        }

        // ç¼–ç æ¶ˆæ¯
        function encodeMessage(msgId, data) {
            // ç®€åŒ–çš„æ¶ˆæ¯ç¼–ç ï¼ˆå®é™…åº”è¯¥ä½¿ç”¨protobufï¼‰
            const jsonStr = JSON.stringify(data);
            const jsonBytes = new TextEncoder().encode(jsonStr);

            const buffer = new ArrayBuffer(8 + jsonBytes.length);
            const view = new DataView(buffer);

            // æ¶ˆæ¯ID (4å­—èŠ‚)
            view.setUint32(0, msgId, true);

            // æ•°æ®é•¿åº¦ (4å­—èŠ‚)
            view.setUint32(4, jsonBytes.length, true);

            // æ•°æ®å†…å®¹
            new Uint8Array(buffer, 8).set(jsonBytes);

            return buffer;
        }

        // å¤„ç†æ¥æ”¶çš„æ¶ˆæ¯
        function handleMessage(data) {
            const view = new DataView(data);

            if (data.byteLength < 8) {
                console.error('æ¶ˆæ¯å¤ªçŸ­');
                return;
            }

            const msgId = view.getUint32(0, true);
            const dataLength = view.getUint32(4, true);

            // è§£ææ•°æ®ï¼ˆç®€åŒ–å¤„ç†ï¼‰
            let msgData = {};
            if (dataLength > 0 && data.byteLength >= 8 + dataLength) {
                try {
                    const jsonBytes = new Uint8Array(data, 8, dataLength);
                    const jsonStr = new TextDecoder().decode(jsonBytes);
                    msgData = JSON.parse(jsonStr);
                } catch (e) {
                    // å¦‚æœä¸æ˜¯JSONï¼Œå°è¯•å…¶ä»–è§£ææ–¹å¼
                    msgData = { raw: Array.from(new Uint8Array(data, 8, dataLength)) };
                }
            }

            // å¤„ç†ç‰¹å®šæ¶ˆæ¯
            handleSpecificMessage(msgId, msgData);

            // æ·»åŠ åˆ°æ¶ˆæ¯åˆ—è¡¨
            const messageName = messageNames[msgId] || `Unknown(${msgId})`;
            addMessage('received', messageName, msgData);
        }

        // å¤„ç†ç‰¹å®šæ¶ˆæ¯
        function handleSpecificMessage(msgId, data) {
            switch(msgId) {
                case 1006: // ç™»å½•å“åº”
                    sessionInfo.playerId = data.roleId;
                    sessionInfo.name = data.name;
                    gameBalance.gold = data.gold || 0;
                    gameBalance.freeGold = data.freeGold || 0;
                    updateUI();
                    break;

                case 1903: // Slotä½™é¢æ›´æ–°
                    gameBalance.gold = data.gold || gameBalance.gold;
                    gameBalance.freeGold = data.freeGold || gameBalance.freeGold;
                    updateUI();
                    break;

                case 1902: // Slotæ¸¸æˆç»“æœ
                    if (data.prize) {
                        gameBalance.totalWin += data.prize;
                        updateUI();
                    }
                    break;

                case 1887: // AnimalåŠ¨ç‰©è¿›å…¥
                    if (data.animal) {
                        data.animal.forEach(animal => {
                            roomAnimals[animal.id] = animal;
                        });
                        updateAnimalList();
                    }
                    break;

                case 1888: // AnimalåŠ¨ç‰©ç¦»å¼€
                    if (data.id && roomAnimals[data.id]) {
                        delete roomAnimals[data.id];
                        updateAnimalList();
                    }
                    break;

                case 1884: // AnimalåŠ¨ç‰©æ­»äº¡
                    if (data.ids) {
                        data.ids.forEach(deadAnimal => {
                            delete roomAnimals[deadAnimal.id];
                        });
                        updateAnimalList();
                    }
                    break;

                case 9903: // Slotè§¦å‘Animal
                    addMessage('system', `ğŸ‰ è§¦å‘Animalæ¸¸æˆï¼ç±»å‹: ${data.type}, å›åˆ: ${data.rounds}`);
                    // è‡ªåŠ¨åˆ‡æ¢åˆ°Animalæ¸¸æˆ
                    setTimeout(() => switchGame('animal'), 1000);
                    break;
            }
        }

        // æ›´æ–°UI
        function updateUI() {
            document.getElementById('playerId').textContent = sessionInfo.playerId || '-';
            document.getElementById('goldBalance').textContent = gameBalance.gold.toLocaleString();
            document.getElementById('freeGoldBalance').textContent = gameBalance.freeGold.toLocaleString();
            document.getElementById('totalWin').textContent = gameBalance.totalWin.toLocaleString();
        }

        // æ›´æ–°åŠ¨ç‰©åˆ—è¡¨
        function updateAnimalList() {
            const listEl = document.getElementById('animalList');

            if (Object.keys(roomAnimals).length === 0) {
                listEl.innerHTML = 'æš‚æ— åŠ¨ç‰©';
                return;
            }

            listEl.innerHTML = Object.values(roomAnimals).map(animal => `
                <div class="animal-item">
                    <span>ID: ${animal.id} - ${animal.animal || 'æœªçŸ¥'}</span>
                    <span>è·¯çº¿: ${animal.lv}</span>
                </div>
            `).join('');
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°ç•Œé¢
        function addMessage(type, title, content = null) {
            const container = document.getElementById('messageContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;

            const time = new Date().toLocaleTimeString();

            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="message-type">${title}</span>
                    <span class="message-time">${time}</span>
                </div>
                ${content ? `<div class="message-content">${JSON.stringify(content, null, 2)}</div>` : ''}
            `;

            container.insertBefore(messageDiv, container.firstChild);

            // é™åˆ¶æ¶ˆæ¯æ•°é‡
            while (container.children.length > 100) {
                container.removeChild(container.lastChild);
            }
        }

        // === é€šç”¨æ“ä½œ ===
        function sendLogin() {
            sendMessage(1006, {
                name: document.getElementById('playerName').value,
                icon: '',
                password: ''
            });
        }

        function sendHeartbeat() {
            sendMessage(1001);
        }

        // === Slotæ¸¸æˆæ“ä½œ ===
        function slotEnterRoom() {
            sendMessage(1901, { type: 1 }); // éº»å°†ç±»å‹
        }

        function slotSpin() {
            const bet = parseInt(document.getElementById('slotBetAmount').value);
            sendMessage(1900, { betamount: bet });
        }

        function slotAutoSpin() {
            stopAutoSpin();
            let count = 0;
            const maxCount = 20;

            autoSpinTimer = setInterval(() => {
                if (count >= maxCount) {
                    stopAutoSpin();
                    return;
                }
                slotSpin();
                count++;
            }, 1000);
        }

        function slotStopAuto() {
            stopAutoSpin();
        }

        function stopAutoSpin() {
            if (autoSpinTimer) {
                clearInterval(autoSpinTimer);
                autoSpinTimer = null;
            }
        }

        // === Animalæ¸¸æˆæ“ä½œ ===
        function animalEnterRoom() {
            const zoo = parseInt(document.getElementById('animalZooType').value);
            sendMessage(1801, { zoo });
        }

        function animalLeaveRoom() {
            sendMessage(1802);
            roomAnimals = {};
            updateAnimalList();
        }

        function animalFire() {
            const targetId = parseInt(document.getElementById('animalTargetId').value);
            const bet = parseInt(document.getElementById('animalBulletLevel').value);
            sendMessage(1803, { id: targetId, bet });
        }

        function animalRapidFire() {
            stopRapidFire();
            let count = 0;
            const maxCount = 10;

            rapidFireTimer = setInterval(() => {
                if (count >= maxCount) {
                    stopRapidFire();
                    return;
                }
                animalFire();
                count++;
            }, 200);
        }

        function stopRapidFire() {
            if (rapidFireTimer) {
                clearInterval(rapidFireTimer);
                rapidFireTimer = null;
            }
        }

        // åˆ‡æ¢æ¶ˆæ¯æ ‡ç­¾
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            // è¿™é‡Œå¯ä»¥æ·»åŠ æ¶ˆæ¯è¿‡æ»¤é€»è¾‘
            console.log('åˆ‡æ¢åˆ°æ ‡ç­¾:', tab);
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        window.onload = () => {
            updateConnectionStatus(false);
        };

        // é¡µé¢å…³é—­æ—¶æ–­å¼€è¿æ¥
        window.onbeforeunload = () => {
            if (ws) {
                ws.close();
            }
        };
    </script>
</body>
</html>