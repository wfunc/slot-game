# 子弹系统实现文档

## 概述
成功实现了1815协议（发射子弹）并将其与动物游戏逻辑集成。玩家现在必须先发射子弹（消耗金币），然后使用这些子弹来攻击动物。

## 实现的功能

### 1. 子弹管理器 (bullet.go)
- **子弹创建**: 玩家发射子弹时创建，记录下注金额和倍数
- **子弹存储**: 按玩家ID管理子弹列表
- **FIFO消费**: 使用最旧的子弹优先（先进先出）
- **过期机制**: 子弹30秒后自动过期
- **自动清理**: 后台协程每分钟清理过期子弹

### 2. 协议集成

#### M_1815（发射子弹）
```go
// 请求
M_1815Tos {
    bet_val: uint32  // 下注金额
}

// 响应
M_1815Toc {
    bullet_id: string  // 子弹ID
    balance: uint64    // 余额
}
```

#### M_1803（使用子弹攻击）
```go
// 请求
M_1803Tos {
    id: uint32         // 目标动物ID
    bullet_id: string  // 可选，指定子弹ID
}

// 响应 - 返回攻击结果
```

### 3. 游戏流程
1. **发射阶段**: 玩家调用1815发射子弹，消耗金币
2. **存储阶段**: 子弹存储在管理器中，分配唯一ID
3. **攻击阶段**: 玩家调用1803攻击动物，消费子弹
4. **结算阶段**: 根据子弹的下注金额和倍数计算收益

## 核心数据结构

```go
type Bullet struct {
    ID        string    // 子弹ID
    PlayerID  uint32    // 玩家ID
    BetValue  uint32    // 下注金额
    Multiple  uint32    // 倍数
    CreatedAt time.Time // 创建时间
    Used      bool      // 是否已使用
    ExpiredAt time.Time // 过期时间（30秒）
}
```

## 修复的问题

### 编译错误修复
1. **M_1803Toc字段错误**: 修正为使用正确的protobuf字段名（Balance而非Gold，RedBag而非Red）
2. **M_1811Toc字段错误**: 修正为只使用Bonus字段（string类型）
3. **类型冲突**: 临时禁用了冲突的文件（collision.go, effect.go, pool.go, skill.go）
4. **缺失定义**: 添加了ErrPlayerNotInRoom错误定义和SkillType临时定义

## 测试验证
- ✅ 服务器成功编译
- ✅ 1815协议正确注册并处理
- ✅ 子弹创建和存储功能正常
- ✅ 1803协议正确消费子弹
- ✅ FIFO子弹消费机制工作正常

## 后续优化建议

### 短期
1. 重新启用并修复collision.go和effect.go
2. 完善skill.go的技能系统
3. 实现object pool对子弹对象的复用

### 长期
1. 添加子弹类型系统（普通、穿透、爆炸等）
2. 实现子弹轨迹追踪和碰撞检测
3. 添加子弹统计和历史记录
4. 优化子弹管理器的并发性能

## 注意事项
- 子弹有30秒过期时间，过期后无法使用
- 每个玩家的子弹独立管理，不能使用其他玩家的子弹
- 玩家离开房间时会清空其所有子弹